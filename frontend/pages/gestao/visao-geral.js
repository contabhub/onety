"use client";

import { useSpring, animated } from 'react-spring'
import { useEffect, useState, useRef } from "react";
import { useRouter } from "next/navigation";
import { FiCalendar, FiAlertCircle, FiXCircle, FiHeart } from "react-icons/fi";
import dynamic from "next/dynamic";
import { FiRefreshCw, FiArrowLeft, FiArrowRight } from "react-icons/fi";
import { CircularProgressbarWithChildren, buildStyles } from "react-circular-progressbar";
import "react-circular-progressbar/dist/styles.css";
import { hasPermissaoCertificado, hasPermissao } from '../../utils/gestao/permissoes';
import PrincipalSidebar from "../../components/onety/principal/PrincipalSidebar";
import styles from "../../styles/gestao/VisaoGeral.module.css";
import SpinnerGlobal from "../../components/onety/menu/SpinnerGlobal";
import ModalEcontador from "../../components/gestao/ModalEcontador";
import ModalPdfLayout from "../../components/gestao/ModalPdfLayout";
import * as React from "react";

// Vari√°veis do backend (padr√£o das outras p√°ginas)
const BASE_URL = (process.env.NEXT_PUBLIC_API_URL || "").replace(/\/$/, "");
const getToken = () => {
    if (typeof window === "undefined") return "";
    return localStorage.getItem("token") || sessionStorage.getItem("token") || "";
};
const getEmpresaId = () => {
    if (typeof window === "undefined") return "";
    try {
        const raw = localStorage.getItem("userData");
        if (raw) {
            const u = JSON.parse(raw);
            return (
                u?.EmpresaId || u?.empresaId || u?.empresa_id || u?.companyId || u?.company_id || ""
            );
        }
    } catch { }
    return sessionStorage.getItem("empresaId") || "";
};

// Helper simples de API baseado em fetch que retorna { data }
const normalizeUrl = (u) => `${BASE_URL}${u.startsWith('/') ? '' : '/'}${u}`;
const api = {
    get: (url, { headers } = {}) =>
        fetch(normalizeUrl(url), { headers })
            .then((r) => r.json())
            .then((data) => ({ data })),
    post: (url, body, { headers } = {}) => {
        const isFormData = typeof FormData !== 'undefined' && body instanceof FormData;
        const finalHeaders = isFormData
            ? { ...(headers || {}) }
            : { 'Content-Type': 'application/json', ...(headers || {}) };
        return fetch(normalizeUrl(url), {
            method: 'POST',
            headers: finalHeaders,
            body: isFormData ? body : (typeof body === 'string' ? body : JSON.stringify(body))
        })
            .then((r) => r.json())
            .then((data) => ({ data }));
    }
};


const SVGComponent = (props) => (
    <svg
        xmlns="http://www.w3.org/2000/svg"
        width={14.042}
        height={14.341}
        {...props}
    >
        <path
            style={{
                fill: "#e86170",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#e86170",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m523.547 348.047 5.484.422-5.484.527zm27.95 0 5.483.422-5.484.527zm-37.02.95 2.53.526-2.53.528zm47.988 0 3.586.526-3.586.528zm-54.95 1.054 2.532.422-2.531.527zm62.016 0 2.426.422-2.426.527zm62.965 21.937 1.055 2.004zm4.957 3.059 1.055 2.004zm-196.91.95L439.488 378zm199.969 1.054.949 1.898zM437.484 378l-.949 2.004zm205.98.95 1.056 2.003zm-208.933 1.054-1.054 2.004zm211.992.95.95 2.003zm-216 2.003-1.054 2.004zm220.008 1.055.95 2.004zm-224.015 2.004-1.055 2.004zm228.023.949 2.004 3.058zm-233.086 3.058-2.953 4.008zm111.059 0 15.504.528-15.504.422zm-10.969.95 3.48.527-3.48.527zm33.96 0 3.481.527-3.48.527zm-41.026 1.054 2.53.422-2.53.528zm47.988 0 2.531.422-2.531.528zm98.086 0 2.953 4.008zm-151.031.95 2.53.527-2.53.527zm-97.032 5.062L406.477 405zm265.043 10.969 4.008 4.957zm-277.066 2.004-2.004 2.953zm64.02 0-.95 2.004zm-2.954 2.004-1.054 2.004zm-3.058 2.004-.95 2.003zm164.004.949 1.054 2.004zm-226.97 1.054-1.054 2.004zm288.985 0 1.055 2.004zm-58.008 2.004 1.055 2.004zm-176.027 2.004-.95 2.004zm237.094 0 .949 2.004zm-296.051.95-.95 2.003zm238.992 0 2.004 3.058zm-240.996 3.058-.95 2.004zm56.004 0-4.008 4.957zm245.004 0 .95 2.004zm-155.988 2.004 5.484.422-5.484.527zm14.976 0 5.485.422-5.485.527zm-22.043.95 2.531.527-2.53.527zm32.063 0 2.531.527-2.531.527zm78.996 1.054 6.012 6.96zm-257.028 7.91-.949 2.004zm51.997 0-4.008 5.063zm265.043 0 .949 2.004zm-49.043 4.008 2.003 3.058zm-158.942 1.055-1.055 2.003zm110.004.949.95 2.004zm-113.062 1.054-.95 2.004zm-60.961.95-1.055 2.004zm176.976 0 1.055 2.004zm-120.023 2.004-.95 2.003zm171.07 0 .95 2.003zM607.5 448.03l.95 2.004zm-184.043.95-.95 2.003zm56.004 1.054-4.008 4.957zm132.996 2.004 10.02 10.969zm47.04 2.004 1.054 2.004zm2.003 2.953.95 2.004zM470.496 459l-4.008 4.957zm-6.012 6.96-.949 2.005zm161.051 0 .95 2.005zm-164.004 4.009-1.054 2.004zm166.957 0 1.055 2.004zm-168.96 3.058-1.055 2.004zm75.937.95 2.531.527-2.531.527zm17.086 0 2.426.527-2.426.527zm79.945 2.003 1.055 2.004zm-120.973 8.016L510.47 486zm68.028 1.055 1.898 2.953zm-73.09 2.953-4.957 6.012zm82.055 6.012 2.004 2.953zM499.5 496.02l-.95 2.003zm93.973 4.957 1.054 2.003zm130.992 4.007.527 2.532h-.949zm-369.985 4.008.528 2.531h-1.055zm371.04 2.004.527 3.48h-1.055zm-330.012 1.055.527 3.48h-1.055zm-41.977 3.902.422 3.586h-.95zm293.942 2.004.527 2.531h-.95zm-253.02 1.055.527 2.531h-.949zm332.016 0 .527 3.48h-.95zm-284.977 2.953.528 5.484h-1.055zm243 1.055.528 3.48h-1.055zm-332.015 2.953.527 7.488h-1.055zm41.027 0 .527 3.48h-1.054zm255.023 1.054.422 17.508H648zm78.996 2.953.528 7.489h-1.055zm-41.976 5.063.422 10.441h-.95zm-244.055 5.906.528 5.59h-1.055zm-47.988 2.004.527 3.586h-1.054zm-41.027 6.012.527 7.488h-1.055zm90.07 2.004.422 2.531h-.95zm47.988 1.054 155.461.528-155.46.422zm193.957.95.528 2.53h-1.055zm-290.039 1.054.527 3.48h-.949zm333.07 6.012.528 4.43h-1.055zm-332.015.95.527 2.53h-1.055zm-41.977 2.003.422 3.48h-.95zm143.016 3.059.95 1.898zm2.953 3.902 2.004 3.059zm226.969 0 .527 2.531h-.95zm-371.989 1.055.528 2.531h-1.055zm321.997 2.004-.95 2.004zM506.46 577.02l2.004 2.953zm5.062 4.007.95 2.004zm155.989.95-1.055 2.003zm-3.059 2.003-.95 2.004zm-124.98 8.016 3.48.527-3.48.528zm95.976 0 7.594.527-7.594.528zm-173.918 4.957.95 2.004zm4.008 5.063 2.004 2.953zm243.95 8.964-.95 2.004zm-232.981 2.004 2.004 3.059zm8.965 7.067 1.054 1.898zm213.996.949-.95 2.004zm-210.938.95.95 2.003zm-70.031 4.007.95 2.004zm2.004 3.059.95 2.004zm6.012 8.015.949 2.004zm110.953 2.004 5.484.422-5.484.527zm114.011 0 3.48.422-3.48.527zm-51.996.95 40.5.527-40.5.527zm-168.96 2.003L435.48 648zm8.964 8.965 5.063 6.012zm-49.992 7.067 1.055 2.003zm58.957.949 1.055 2.004zm-56.004 3.058 1.055 2.004zm60.012 0 1.055 2.004zm-56.004 4.957 1.055 2.004zm5.063 6.012 14.976 16.031zm114.96 14.977 3.48.527-3.48.527zm14.028 1.054h116.015l2.426 2.426-2.426-1.476H530.508zm-109.055 2.953 1.055 2.004zm5.063 4.008.949 2.004zm4.007 3.059.95 2.004zm2.954 2.004 1.054 1.898zm6.011 3.902 1.055 2.004zm201.973 13.078-.95 2.004zm-4.957 4.957-1.055 2.004zm-139.957 5.063 2.426.422-2.426.527zm5.906.949 2.531.527-2.53.422zm7.067.95 3.48.527-3.48.527zm10.02 1.054 6.433.527-6.434.422zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#f8d4d9",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#f8d4d9",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m530.508 346.992 18.457.528-18.457.527zm-12.024 1.055 4.536.422-4.536.527zm39.024 0 3.48.422-3.48.527zm-45.985.95 2.426.526-2.426.528zm54.95 0 2.53.526-2.53.528zm6.011 1.054 2.532.422-2.532.527zm5.063.949 2.426.527-2.426.422zm-145.02 29.953-1.054 2.004zm216 1.055.95 2.004zm-220.007 2.004-1.055 2.004zm224.015.949.95 2.004zm-228.023 2.004-2.004 3.058zm232.98 2.004 2.004 3.058zm-131.941 2.004 4.43.527-4.43.527zm23.941 0 5.485.527-5.485.527zM418.5 392.027l-4.957 6.012zm99.035 0 2.426.422-2.426.528zm41.977 0 2.531.422-2.531.528zm103.992 2.004 14.976 15.926zM405.527 405l-5.062 6.012zm211.993 8.016.949 2.004zm-220.008.949-2.004 3.058zm284.976 0 2.004 3.058zm-62.015 1.055 1.054 2.003zm4.007 2.953 1.055 2.004zm-230.976 1.054-2.004 2.953zm60.012 0-2.004 2.953zm232.98 0 1.055 2.004zm-58.008 2.004 1.055 2.004zm-180.035 2.004-2.004 2.953zm240.996 0 1.055 2.004zm-55.898 2.004 14.976 15.926zm-91.02.95 4.43.527-4.43.527zm-155.039 1.054-.949 2.004zm143.016 0 3.48.422-3.48.527zm24.996 0 3.48.422-3.48.527zm137.004 0 .949 2.004zm-168.012.95 2.531.527-2.53.527zm37.969 0 2.531.527-2.531.527zm-176.977 2.003L384.54 432zm55.055 0-6.012 6.961zm253.969 0 .949 2.004zm-311.028 2.953-.949 2.004zm313.032 0 .949 2.004zm-199.97 5.063-1.054 2.004zm-66.023 2.953-3.058 4.008zm220.957 3.058 2.004 2.954zm-166.007.95-.95 2.004zm120.023 1.054 1.055 2.004zm-180.035.95-.95 2.003zm56.004 1.054-.95 2.004zm128.039.95 2.004 3.058zm45.984 0 1.055 2.003zm-232.98 2.003-1.055 2.004zm52.945 2.004-5.906 6.961zm-54.95 1.055-1.054 2.004zm-2.003 2.953-.95 2.004zm245.004 4.008.95 2.004zm-39.973 2.004 2.004 2.953zm-157.992.949-1.055 2.004zm-3.059 4.008-.949 2.004zm165.06 0 .948 2.004zm-89.017 6.012 13.5.527-13.5.527zm35.965 8.015 1.055 2.004zm-60.96 1.055-1.055 2.004zm64.019.95.95 2.003zM509.52 486l-2.004 2.953zm72.984 2.004 4.957 6.012zm-80.05 4.957-2.005 3.059zm88.066 4.008.949 2.004zm-91.97 1.054-1.054 2.004zm-2.003 2.954-1.055 2.003zm-2.004 3.058.95.95 99.456.527-100.933.527zm186.996 2.953.422 2.532h-.95zm43.98 1.055.528 2.426h-1.055zm-78.996.95.528 2.53h-1.055zm35.965 3.058.528 2.426h-1.055zM353.531 513l.422 2.531h-.95zm89.016 0 .422 2.531h-.95zm204.926 2.004.527 2.531h-.95zm78.996 0 .527 3.48h-.95zm-42.926 2.953.422 3.586h-.95zm-242.05 1.055.527 2.531h-1.055zm-89.016 2.004.527 4.535h-1.055zm41.976.949.527 2.531h-.949zm254.074 0 .422 4.535H648zm78.996 3.058.528 4.43h-1.055zm-43.03 2.004.527 5.485h-1.055zm-243.95 2.004.422 10.442h-.95zm-47.04.95.528 12.55h-1.054zm-41.976 7.066.422 8.437H351zm376.946 4.957.527 14.45h-.95zm-79.946 2.953.422 4.535H648zm-207.035 2.004.528 2.531h-1.055zm243 1.055.528 4.535h-1.055zm-290.039 2.953.527 2.531h-.949zm253.02 0-.95 2.004zm-294.996 6.011.527 4.536h-1.055zm43.03 1.055.528 2.426h-1.055zm.95 6.012.527 2.426h-.949zm331.066.95.528 3.48h-1.055zM353.531 567l.422 2.531h-.95zm145.02.95.949 2.003zm178.98 3.058-1.054 2.004zm-175.078 2.004 3.059 4.008zm172.02 2.004-6.012 6.96zm-318.938 4.007.422 2.426h-.95zm153.985 0 .949 2.004zm25.945 12.024 2.531.422-2.531.527zm109.055 0 2.53.422-2.53.527zm-186.997.95.95 2.003zm85.957 0 91.547.526-91.547.528zm-83.953 2.952.95 2.004zm2.953 4.008 2.004 3.059zm5.063 6.012 7.91 9.07zm247.008 0-1.055 2.004zm-3.059 4.008-.949 2.003zm-4.008 5.062L701.473 621zm-228.023 2.004 1.055 2.004zm4.008 2.953 1.054 2.004zm-66.973 2.953 1.055 2.004zm280.969 1.055-.95 2.004zm-274.957 8.016.949 2.003zm2.004 2.953 2.004 3.058zm102.937 4.007 2.531.528-2.53.527zm135 0 2.531.528-2.53.527zm-233.93 1.055 2.004 2.953zm104.942 0 3.586.422-3.586.527zm122.027 0 3.48.422-3.48.527zm-108 .95 51.469.527-51.469.527zm93.024 0 8.437.527-8.437.527zM436.535 648l2.004 2.953zm-53.05 2.004 1.054 2.004zm2.003 2.953 1.055 2.004zm60.012 3.059 2.004 2.953zm-54.95 4.007.95 2.004zm59.907 0 1.055 2.004zm4.008 2.954 1.055 2.003zm-60.961 1.054 2.004 2.953zm4.008 4.957 2.953 4.008zm10.968 12.024 1.055 2.004zm103.993 6.011 2.53.528-2.53.422zm8.015.95 5.485.527-5.485.527zm-102.937 1.054 2.953 4.008zm231.926 4.008.527 5.485h-1.055zm-226.02.95 2.004 3.058zm5.063 4.007.949 2.004zm214.945 18.035-.95 2.004zm-4.008 4.957-2.004 3.059zm-4.957 4.008-.95 2.004zM499.5 729l2.531.527-2.531.422zm6.96.95 2.532.527-2.531.527zm9.071 1.054 3.48.527-3.48.422zm14.977.95 87.539.526-87.54.528zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#fffdfd",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#fffdfd",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m527.45 346.992 2.53.528-2.53.527zm22.042 0 3.48.528-3.48.527zm105.996 39.973 1.055 2.004zm-234.984 3.058-1.055 2.004zm110.004.95 3.48.527-3.48.527zm14.976 0 3.48.527-3.48.527zm116.016 1.054.95 2.004zm18.035 17.93.95 2.004zm-280.02 1.055-1.054 2.004zm230.977 12.023 1.055 2.004zM445.5 425.988l-2.004 3.059zm93.023 0 3.48.528-3.48.527zm8.965 0 3.48.528-3.48.527zm-114.96 12.973-1.055 2.004zm216.949 3.059 1.054 2.003zm-172.02 8.964-.95 2.004zm136.055 1.055 8.965 9.914zm-145.02 7.91-.949 2.004zm157.992 6.012 1.055 2.004zm-120.023 22.992-2.953 4.008zm82.055 6.012.949 2.004zm139.007 27 .528 2.531h-1.055zm-286.98 4.008.422 2.53h-.95zm-89.016 5.062.422 5.485H351zm332.965 2.004.528 6.434h-1.055zm43.98 2.953.528 5.485h-.95zM440.544 540l.422 2.531h-.95zm243.95.95.527 6.538h-1.055zm-290.04 4.007.527 5.59h-.949zm-42.926 1.055.422 5.484H351zm139.957 6.96 153.563.528-153.563.527zm236.989 4.008.527 3.48h-.95zm-262.934 45.985.95 2.004zm243.95 9.07-.95 2.004zm-232.981 2.004.949 2.004zM700.523 621l-1.054 2.004zm-157.992 18.984 4.43.528-4.43.527zm106.946 0 2.53.528-2.53.527zm-218.004 2.004 2.004 3.059zm11.074 10.969 2.004 3.059zM402.469 675l5.062 6.012zm8.015 8.016 4.008 4.957zm116.016 4.957 12.55.527-12.55.527zm89.965 0 28.582.527-28.582.527zm31.008 1.054 1.054 2.004zm-6.012 29.953-.95 2.004zM526.5 731.953l3.48.527-3.48.528zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#fff",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#fff",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="M536.52 475.031h16.98l14.027 4.008c8.227 3.691 15.082 8.86 20.461 15.504l6.961 9.914-99.457.527.528-1.476c3.375-7.278 8.226-13.078 14.449-17.508 6.855-5.484 15.61-9.176 26.05-10.969zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#e6384a",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#e6384a",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m534.516 348.047 2.53 1.476-7.593.528v-1.055zm10.968 0 5.485 1.476-8.438.528v-1.055zm-25.945.95.422 2.003-2.953-.527zm-8.016 1.054.528 1.898-2.004-.422zm-83.003 35.965-1.055 2.004zm-5.063 2.953.527 1.582-2.004.949zm103.992 0 3.586.527-3.586.527zm21.094 0c2.848-.95 4.008-.422 3.48 1.582l-1.476-.528c-2.004.317-2.742 0-2.004-1.054zm10.969 1.054c1.476-.527 2.004 0 1.476 1.477zm6.011.95c1.477-.422 2.004.105 1.477 1.476zm93.024 1.054.95 2.004zm-243 4.957-11.074 12.024-1.477-.528zm251.965 2.004 4.957 6.012 2.531 1.477-1.477.527-6.539-6.54zm12.023 14.028 2.004 2.953zm-280.02.949-1.054 2.004zm228.973 5.062 1.055 2.004zm56.004 0 1.055 2.004zm-236.039 2.004-.422 1.477-.527 1.476-.527-1.476zm185.098 2.004 2.426 3.48h-.95zm-192.059 4.008-10.02 10.969zm99.035.95 8.438.527-8.438.527zm108.95 10.968 1.054 2.004zm-43.98 9.07 1.054 2.004zm4.956 2.953 1.582 2.532-2.004-1.055zm-141.96 12.024-.95 2.004zm153.034 0 .95 2.004zm-81 8.965 9.493.527c-.844 1.898-1.688 2.004-2.532.527-3.164-.843-5.168-.527-6.011.95zm-7.488 1.054 2.004.422-2.004 1.055zm-23.52 10.97L508.466 486zM582.505 486l2.004 2.953zm2.953 4.008 4.535 3.48-2.531-1.476zm135 2.953 4.535 26.05-37.969 12.973-4.007-23.52 11.496-5.484 23.941-8.015zm-228.445 11.074 2.004.422-.528 2.531zm-135.528 2.004.528 2.004-2.004-.527zm-.949 6.012.422 2.426h-.95zm289.934 1.898 1.054 2.004c-1.898.527-2.214-.105-1.054-2.004zm-252.492 3.059 2.003.527-2.003.95zm-38.497 2.953.528 3.586-2.004-1.055zm288.985 2.004 3.586.527v24.047l-9.598 4.43h-69.926v-.95zm-251.016 1.055.528 2.53h-.95zm50.098 4.957.422 12.55h-.95zm-89.016 7.066.422 12.445h-.95zm.95 23.941.527 3.48h-1.055l-.95-2.003zm1.054 8.965.422 2.531h-.95zm144.914 5.063 10.02 10.02 15.504 8.437-51.47 18.562c-1.16-2.11-2.32-2.636-3.48-1.582l.95-.949-6.012-6.012-7.91-10.968 42.926-16.032zm-144.914 2.004c1.477-.528 2.004 0 1.477 1.476zm2.004 10.02c1.477-.528 2.004 0 1.477 1.476zm49.992 22.991 4.957 10.97 1.477-.528v2.004l6.012 10.02-39.024 13.5-10.969-21.516 27.528-9.493zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#e63a4a",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#e63a4a",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m529.453 348.047 4.535.422-4.535.527zm17.086 0 4.43.422-4.43.527zm-9.07.95 5.062 1.054h16.98l2.005-1.055v1.055l-1.477.422 22.465 3.48 1.476-.422-.527 1.477 4.008-1.055v2.004l4.008-.95v2.005l3.058-1.055v2.004l8.016 2.004 1.477-.422-.528 1.477 3.059-1.055v2.004l3.902 1.054 1.582-.527-.527 1.477 2.004-.95v2.004l16.98 8.016 1.477-.527-.422 1.476 3.902 2.004 1.582-.527-.527 1.582 10.969 6.96 1.476-.527c-1.476.844-1.265 1.688.528 2.532l2.003.949 1.477-.422c-1.371.844-1.266 1.687.527 2.426l3.059 2.004 1.477-.422c-1.793 1.16-1.372 2.32 1.476 3.48l4.008 2.953c1.16-1.793 2.32-1.265 3.48 1.477l-.949 1.055 8.438 8.437c.843-1.371 1.687-1.266 2.53.527l-1.054 1.055 3.059 2.953 2.531 3.48c.738-1.476 1.582-1.265 2.426.528v2.004l1.582 2.531 1.476-.527c-1.687.95-1.37 2.004.95 2.953l3.48 5.59 1.582-.527v2.003l.422 1.477 1.582-.527v2.004l.422 1.476 1.582-.422-1.055 2.004 2.532 3.48 1.476-.527-.95 2.004 2.427 3.48 1.476-.421-.949 1.898h2.004l-1.055 2.004L708.54 459l1.477-.527-1.055 2.004h2.004l-.95 2.003 1.477 3.48 1.477-.42-.95 2.003h2.004l-1.054 2.953h2.004l-.95 2.953 4.43 12.551 1.582-.527-1.055 4.007h2.004l-2.53 5.485-34.911 13.078-1.055-4.008-1.476.422.949-4.008h-2.004l1.055-3.902-1.477-3.586-1.582.527 1.055-2.953h-2.004l.95-3.058h-2.005l1.055-2.954H675l.95-2.003-1.477-3.48-1.477.42 1.055-2.952-1.582-2.531-1.477.527 1.055-2.004h-2.004l.95-2.004h-2.005l1.055-2.004h-2.004l.95-2.004-3.481-5.484-1.477.527.95-2.004-5.485-7.488-1.476.422v-2.004l-.528-1.477-1.476.528c1.687-1.055 1.265-2.004-1.055-3.059l-1.477-2.426-1.476.528c1.687-1.055 1.37-2.004-1.055-3.059l-2.426-3.48c-1.265 1.898-2.425 1.37-3.48-1.477l.95-1.055-7.49-7.488c-.843 1.582-1.687 1.371-2.53-.527l1.054-.95-3.48-3.48-3.059-2.004-1.476.422c1.476-.738 1.37-1.582-.528-2.426l-2.004-1.054-1.476.527c1.476-.844 1.37-1.582-.528-2.531l-2.003-.95-1.477.528.527-1.582-2.004-.95-1.476.528.422-1.582-4.008-2.004-1.477.527.528-1.476-4.008-2.004-1.477.527.422-1.582-1.898 1.055V405l-2.004.95v-1.9l-2.004.95v-2.004l-2.004 1.055v-2.004l-6.012-2.004-1.476.422.422-1.477-6.961-2.004-1.477.528.422-1.477-24.996-6.012-33.012-1.054-8.437 1.582 2.004.949-1.477.527c-.844-1.476-2.848-1.793-6.012-1.054v2.004l-5.062-.95v2.004l-4.008-1.054v2.003l-4.008-.949v2.004l-2.953-1.055v2.004l-2.953-.949v2.004l-3.059-1.055v2.004l-2.953-.949v2.004l-2.004-1.055-3.48 1.477.422 1.582-2.004-1.055v2.004l-2.004-.95-10.441 5.485.527 1.477-2.004-1.055v2.004h-2.004L459 413.543l.527 1.477h-2.004l-2.53 1.476.527 1.477h-2.004l-2.532 1.476.528 1.582h-2.004l-3.48 2.426.421 1.582-.949-1.055-2.953 3.059-11.496 10.441-3.059 4.008.528 1.477c-.844-1.477-1.688-1.266-2.532.527l-2.004 2.953.528 1.582c-.844-1.476-1.688-1.37-2.532.422l-.949 2.004.422 1.582-1.476-.527-.95 2.004.422 1.476c-.738-1.476-1.582-1.265-2.426.528l.95 2.003h-2.004l-2.004 4.008.527 1.477-1.476-.528-7.067 14.977.528 1.582-1.477-.527-.95 4.008.423 1.476-1.477-.527-.95 4.008.423 1.476-1.477-.422 1.055 2.953h-2.004l.95 3.059h-2.005l-2.004 8.965.528 1.476-1.477-.527.95 4.008h-2.005l-2.953 15.082v29.004l2.426 12.445 1.582-.527c-1.476.949-1.793 2.847-1.055 6.011l1.477 4.536 1.582-.528-1.055 5.063 1.477 3.48 1.582-.527-1.055 4.008h2.004l-.949 2.953h2.004l-1.055 3.058h2.004l-.95 2.954h2.005l-1.055 3.058H405l-.95 2.953 1.477 2.532 1.477-.528-1.055 3.059 1.055 2.426-37.547 14.027.527-1.477-.527-1.476-1.477.422 1.055-2.953-1.582-2.532-1.476.528 1.054-3.059-2.531-5.484-1.477.527.95-2.953h-2.004l1.054-3.059-1.476-4.535-1.582.527 1.055-4.007-1.477-3.48-1.582.527 1.055-5.063-3.059-10.969-.95-14.976-1.054-1.055v-33.96l1.055-.95.949-15.082 5.063-21.938-.528-1.476 1.477.422 4.008-13.922-.528-1.582 1.582.527.95-4.008-.528-1.476 1.582.527 2.004-6.012-.527-1.476 1.476.422-.949-2.004h2.004l2.953-6.961-.527-1.477 1.582.422-1.055-2.004H378l-.95-1.898h1.9l2.003-4.008-.422-1.582 1.477.527 2.004-4.008-.528-1.476 1.477.527 1.055-2.004-.528-1.476 1.477.422 1.055-2.004-.528-1.477c.844 1.582 1.688 1.371 2.531-.527l2.954-4.957-.528-1.477c.95 1.477 1.793 1.371 2.531-.527l2.004-2.953-.527-1.582c1.266 1.898 2.426 1.37 3.586-1.477l2.004-2.953c-1.477-.95-1.371-1.687.422-2.531l1.054.949 13.5-13.5c-1.476-.844-1.37-1.687.528-2.426l.949.95 2.953-2.954 3.586-2.53-.527-1.477h2.004l2.53-1.477-.526-1.582h2.003l2.426-1.477-.422-1.476h2.004l7.489-4.535-.528-1.477h2.004l1.477-.527-.422-1.477 1.898 1.055 5.59-3.586-.527-1.477 2.004 1.055v-2.004l2.004.95v-2.005l2.003 1.055v-2.004l2.004.95v-2.004l2.004 1.054v-2.004l2.004.95v-2.004l2.004 1.054 3.48-1.476-.527-1.582 2.004 1.054v-2.003l2.953.949v-2.004l3.059 1.055 2.531-1.477-.527-1.582 2.953 1.055v-2.004l4.008.949 3.48-1.477-.422-1.476 4.008.949 8.438-2.426-.528-1.582 5.063 1.055v-1.055l-1.477-.422 1.477-.527c.843 1.477 2.847 1.793 6.011.95l8.965-1.9h16.032zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#e63a4a",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#e63a4a",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m528.504 390.023 3.48.528-3.48.422zm20.039 0 2.426.528-2.426.422zm-8.016 37.02 8.438.422-8.438.527zm-8.015 2.004h23.941L571.535 432l1.477-.527-.528 1.476 8.016 2.004 1.477-.422-.528 1.477 4.008.949 1.582-.422-.527 1.477 6.96 2.953 1.477-.422-.422 1.477 2.004-1.055v2.004l8.016 5.062 1.476-.527c-1.476.844-1.37 1.687.528 2.531l1.898.95 1.582-.528c-1.898 1.266-1.37 2.426 1.477 3.586L621 462.48l2.531 3.48 1.477-.42c-1.688.948-1.371 2.003.949 2.952l3.586 5.485 1.477-.528-1.055 2.004 2.531 3.586 1.477-.527-.95 2.004 5.485 10.441 1.476-.422-.949 2.004 1.477 3.48 1.476-.527-.949 3.059h2.004l-1.055 2.953h2.004l-.949 4.008h2.004l-1.055 4.957c1.899 3.058 2.531 6.96 2.004 11.496l-33.539 11.074-45.984 17.93h-76.465l-1.055 4.535h2.004l-.95 2.004 3.481 6.539 1.477-.527-.95 2.003 3.481 4.43 1.477-.422c-1.688.95-1.266 2.004 1.054 2.953l.95 2.004-42.504 15.504-2.426-.527.95-2.004-6.54-12.445-1.477.527 1.055-2.004-1.582-3.586-1.476.527 1.054-2.953h-2.004l.95-4.007-2.426-8.543-1.582.527c1.582-.844 1.898-2.848 1.054-6.012h-1.054l-.422 1.477-.527-1.477.949-.949v-28.055l-.95-2.004h.95l.527 1.477.527-5.484-.527-1.477 1.477.527-.95-5.062h2.004l-1.054-4.008h2.004l-.95-2.953h2.004l-1.054-2.953h2.003l-.949-3.059h2.004l.95-4.008-.528-1.476 1.582.527-1.055-2.004h2.004l3.059-7.066-.527-1.477 1.476.528-.95-2.004h2.005l4.957-8.016-.528-1.476 1.477.527 2.004-3.059-.422-1.476c1.055 1.898 2.215 1.37 3.48-1.477l2.954-4.008-.95-1.054 3.48-3.48.95 1.054 4.008-4.008 2.531-1.582-.527-1.477c1.055 1.688 2.004 1.372 3.058-.949l1.477-.527-.527-1.477h2.004l4.535-2.53-.528-1.477h2.004l3.48-1.477-.421-1.582 2.004 1.055v-2.004l1.898.949v-2.004l2.004 1.055v-2.004l2.004.949 3.586-1.477-.527-1.476 2.953.95 6.539-2.427-.528-1.476 4.008.949zm8.437 42.926-13.922 3.058v2.004l-1.054-1.055-4.008 1.055v2.004l-2.004-1.055v2.004l-2.004-.949v2.004l-.95-1.055-4.007 2.004v2.004l-.95-.95-2.003.95c-2.004.633-2.426 1.688-1.055 2.953-.633 1.371-1.37 1.371-2.004 0l-6.96 7.067.949.949-.95-.95-2.004 2.954v2.004l-3.058 1.054 1.055 2.004-1.055-1.054-2.953 5.062 2.004-1.055v2.004h101.988l.95-.949-2.005-5.062H594v-.95l-4.008-6.011-4.008-5.063-.949 1.055v-1.055L581.977 486c-1.266-2.637-2.32-2.953-2.954-.95v-1.054l-1.054-.95h-2.004v-1.054l-6.961-4.957-2.953.95v-.95l-5.063-3.058-4.957 1.054v-1.054l-6.011-2.004zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#e63a4a",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#e63a4a",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m542.531 473.027 5.485.422-5.485.528zm-101.039 54.95.528 12.55h-1.055zm244.055 4.007.422 2.532h-.95zm-333.07 2.004.527 14.555h-1.055zm375.046 4.008.528 7.488h-1.055zm-41.976 8.016.422 2.531h-.95zm41.976 6.96.528 6.54h-1.055zm-54 24.048-2.003 2.953zm-205.03 27.949 2.003 3.058zm4.007 4.008 2.953 4.007zm234.984 4.007-.949 2.004zm-6.011 6.012-.95 2.004zm-174.024 70.031 2.531.422-2.53.528zm112.008 31.008-2.004 2.953zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#e13347",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#e13347",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m535.465 348.047 9.492.422-9.492.527zm-10.969.95 4.535.526-4.535.528zm27 0 3.48.526-3.48.528zm10.969 1.054 2.531.422-2.531.527zm-76.992 5.906-.95 2.004zm-8.965 3.059-1.055 2.004zm131.941 2.004 1.055 2.003zm-141.96 2.003 1.476.528-2.426 1.476zm147.972.95 4.535 2.53-1.476-.526c-2.532-.211-3.586-.844-3.06-2.004zm12.023 6.011 3.48 1.477-1.476.527zm-178.03 2.004 1.581.528-2.531 1.476zm185.097 2.004 2.426 1.477-1.477-.422zm-200.074 8.016-.95 2.004-1.476-.528zm213.996.949 2.53 1.582-1.476.422zm4.007 3.059 2.532 1.476-1.477.528zm-120.023 2.953 16.559.527-16.559.527zm24.996 1.054 2.531.528-2.53.422zm100.09 0 2.426 1.477-1.477.527zM418.5 394.031l-2.004 2.953-2.953 2.004 2.004-2.953zm245.004 2.004 2.953 4.008zm-72.984 2.004.949 2.004zm-103.993.95-1.054 2.003-1.477-.527zm108.95 1.054 2.53 1.477-1.476.527zm72.984 0 4.008 4.957zm-189 2.004-.95 2.004-6.96 2.953v-1.055zm-73.934 3.902-1.054 2.004zm268.946 1.055 2.004 2.953zm-270.95 2.004-2.003 2.953zm62.965 0-.949 2.004-1.582-.528zm-68.976 6.012.527 1.476-2.004 1.055zm48.937 8.015-.949 2.004zm190.055 2.953 2.004 3.059zm-101.04 2.004 4.536.528-4.535.527zm14.028 0 4.535.528-4.535.527zm-108.949 1.055-6.012 6.96zM513.527 432l-1.054 2.004zm62.016 0 .95 2.004zm2.953.95 1.055 2.003zm66.024 1.054 5.484 6.539-2.004-1.055zm-139.008.95 1.476.526-2.531 1.477zm76.992 0 2.531 1.581-1.582-.527zm-153.984 6.01-.528 1.583-.527 1.476-.422-1.476zm64.968 0 1.477.528-2.426 1.477zm159.047 2.005.95 2.004zm-228.023 3.058-1.055 2.953-.422-1.476zm58.008 2.953-1.055 2.004-1.477-.527zm222.011 0 3.48 6.54h-1.054zm-96.082 1.055 1.055 2.004zm-132.996 4.957-3.902 4.957zm-105.996 6.961-.95 2.004zm341.086 0 1.477 2.531h-1.055zm-44.086 1.055 1.582 2.531-2.004-1.055zm-253.969.949.528 1.582-1.477 2.426-.527-1.477zm54 0 .528 1.582-2.004.95zm157.043 0 1.477 2.531-2.004-.949zm-256.078 3.059-.95 2.004zm345.094 0 1.476 2.53h-1.054zm-304.067 4.957.528 1.476-2.531 3.586.527-1.582zm306.07 0 .95 2.004zM364.5 475.03l-.95 2.004zm197.965 0 1.055 2.004zm153.035 0 .95 2.004zm-149.977.95 4.43 2.53-1.476.528zm-201.972 2.003-1.055 2.004zm352.898 0 1.055 2.004zm-144.914 1.055 2.426 1.477-1.477.527zm62.965.95 1.477 3.48h-.95zm39.973 1.054 1.054 2.004zm-270.95 4.008-1.054 1.898zm232.98 0 2.532 3.48-2.004-1.054zM507.517 486l-1.055 2.004zm74.988.95.95 2.003zm2.953 2.003 1.055 2.004zm-135 3.059-.95 2.004zm51.047 0-1.477 2.531-.527 1.477-.527-1.477zm85.957 0 1.055 2.004zm51.996 0 1.055 2.004zm40.078 4.008.95 2.003zm41.977 0 1.476 2.53-2.004-1.054zm.949 4.957 1.582 2.53-2.004-1.054zm-126.984 1.054 1.476 3.48-2.004.95 1.055-2.004zm128.039 4.957 1.476 2.532-2.004-1.055zm-328.008 4.008-.528 1.477-.527 2.53-.422-2.53zm328.957 2.953 1.582 2.531-2.004.528zm-77.942 5.063.528 2.531h-1.055zm76.993 0c2.004-.633 2.53.527 1.476 3.48l2.004 4.008-.95.95v33.538l-51.573 18.035-2.004 2.004 2.531-3.48-.527-1.582c.843 1.582 1.687 1.37 2.53-.422l2.954-5.063-.422-1.476 1.477.527 2.953-8.015-.422-1.477 1.477.422.949-8.965-.95-2.004 2.004-2.004v-10.02l-2.003-8.437h2.003c-1.054 2.426-.527 3.48 1.477 2.953zm-39.024.949 1.477 3.586h-.95zm-241.945 4.008.422 3.48h-.95zm-89.016 5.062.422 5.485h-.95zm38.918 2.004.528 9.492h-.95zm255.024 2.004.527 2.426h-.95zm-204.926 7.91.422 3.586h-.95zm-50.098 3.059.528 2.531h-.95zm335.074 2.004.528 6.539h-1.055zm-81 .949L648 550.02l-4.535 2.003h-152.93v-1.054h146.918zm-292.992 1.055.422 5.484h-.95zm137.004 8.964 2.426 4.536h-.95zm-45.035 6.012.95 2.004zm51.996 4.957 1.477 2.531-2.004-.949zm-49.043 4.008 1.055 2.004zm53.05 1.055 2.954 4.008zm-51.046 4.008 2.531 3.48-2.004-.95zm59.063 4.007c1.476-.527 2.003 0 1.476 1.477zm2.953 2.004c1.582-.527 2.109 0 1.476 1.477zm13.078 6.012.422 2.004 2.53-1.055 2.005 2.004 8.965 2.004h82.054l.95.95 1.054-.95h8.965v.95l-39.973 14.027-5.062 3.058-16.98 4.957-23.942 10.02-14.027 4.008-8.016 4.007c-3.164-.843-5.168-.527-6.012.95v-2.004l-10.968-2.953-1.477.527.422-1.582-14.977-6.961-1.476.527L488.53 621l-3.058-2.004-1.477.527-2.531-3.48-1.477.422-4.957-6.012 50.942-18.984zm-124.031 2.953.949 2.004zm.949 2.953 1.054 2.004zm62.015 4.008 1.055 2.004c-1.898.527-2.215-.211-1.055-2.004zm-102.937 1.055.95 2.004zm44.93 4.957 1.476 2.531h-.95zm64.02 1.054 2.003 2.954zM364.5 608.977l.95 2.003zm2.953 8.015 1.055 2.004zm49.043 8.016 1.055 2.004zm-45.035.949 1.055 2.004zm46.09 5.063c2.531-.528 4.008 0 4.43 1.476l1.476 2.531 1.582.422-1.055 1.055 3.48 3.48 1.583.528-1.055.949 8.016 8.016 3.48 4.535 6.012 4.957 1.477-.422c-1.477.844-1.266 1.687.527 2.426l2.531 1.476-2.531.528-39.973 14.976c-9.597-9.387-17.93-20.039-24.996-31.957l-1.582-.527 3.586-2.426zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#dc2e45",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#dc2e45",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m555.504 348.996 2.531.527-2.531.528zm-128.988 37.969-1.055 2.004zm228.023 1.055.95 2.003zm-130.992 2.003 2.426.528-2.426.422zm-102.094.95-2.004 3.058zm238.043 1.054 2.953 4.008zm-247.008 6.961-6.011 6.961zm265.043 10.969 2.953 4.008zm-277.066 2.004-2.004 3.059zm54 5.062-.95 2.004zm229.078 0 2.004 2.954zm-288.035.95-1.055 2.004zm230.976 0 1.055 2.004zm-176.027 2.004-.95 2.003zm-58.008 2.003-.949 2.004zm239.098 0 2.004 3.06zm56.004 0 .949 2.004zm-243 3.06-3.059 4.007zm-55.055.948-.95 2.004zm-2.004 3.059-.949 2.004zm251.965 0 4.008 4.957zm53.05 0 .95 2.004zM385.489 432l-.949 2.004zm309.024 0 .949 2.004zm-261.035 4.008-4.008 4.957zm217.054 4.957.95 2.004zm-224.015 3.058-1.055 2.004zm228.023 2.004.95 2.004zm-170.016.95-1.054 2.003zm172.97 3.058 1.054 2.004zm-178.032.95-2.953 4.007zm-58.957 1.054-1.055 2.004zm191.004 0 10.969 11.918zM418.5 454.992l-.95 2.004zm51.996 4.957-2.953 4.008zm-6.012 7.067-.949 2.004zm161.051 0 .95 2.004zm-49.043 14.976 1.055 2.004zm4.008 3.059.95 1.898zm-74.988 2.953-3.059 4.008zm83.953 6.012 1.055 2.004zm-90.914 2.004-1.055 2.003zm224.965 8.015.527 2.426h-1.055zm-228.973 2.004 100.406.422-100.406.527zm229.922 4.008.527 3.48h-.949zm-369.985 4.957.528 2.531h-1.055zm292.043.95.528 2.53h-1.055zm37.97 1.054.527 2.531h-1.055zm41.027 0 .527 5.484h-1.055zm-282.973 4.008.422 2.53h-.95zm243 2.953.422 4.535h-.95zm-332.016 1.054.422 3.48h-.95zm293.942 0 .527 7.489h-.95zm-255.024 2.954.528 2.53h-.95zm334.02 4.007.527 29.532-.95 4.957.95 2.004-2.004 5.062c1.688.95 1.371 2.004-.949 2.953l.95 3.059-2.005.422-.949 5.484.422 1.582c-1.688-.527-2.215.211-1.477 2.426l-2.953 6.012.422 1.476-1.476-.422 1.054 2.004-3.058 2.004-4.957 7.91.527 1.582-1.582-.527-4.957 6.012c1.582.843 1.371 1.687-.527 2.53l-.95-1.054L698.52 621l-2.532 1.477.528 1.476h-2.004l-16.559 8.543.527 1.477-2.953-.95-3.48 1.477.422 1.477-4.008-.95-6.012 2.004-16.98.95-.95 1.054h-82.054l-.95.95h-12.972l-7.066-2.005h-8.016l-12.445-2.53 44.507-15.4 4.957-3.058 16.98-4.957 24.048-10.02 14.027-4.007 8.016-4.008c5.484.844 9.492.21 11.918-2.004l2.004 1.055 6.011-3.059h2.004c2.215.738 3.059.211 2.532-1.476h2.003l.528-1.477 1.476.422c-.527-2.004.422-2.426 2.953-1.477v-2.004h2.532l1.476-2.953 2.532-1.054c.949 1.687 2.003 1.37 2.953-.95l51.574-18.035zm-78.996 4.008.527 11.496h-.95zm39.023 1.055.527 10.441h-1.054zm-294.047 3.902.528 2.531h-.95zm50.098 4.008.422 2.531h-.95zm-89.016 9.07.422 3.48h-.95zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#dc2e45",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#dc2e45",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m685.547 554.977.422 1.476-2.004 1.055zm-2.004 7.066.422 2.004-2.004-.527zm-329.063 2.953.528 2.531h-1.055zm145.02 6.012.95 2.004zm178.453 0 2.004.527-2.004.95zM675 575.016l2.004.527-2.953 2.004zm-169.488 2.004 2.953 4.007zm10.968 8.015 4.536 2.426-1.477.527zm-58.957 4.957.95 2.004zm75.938 2.004 3.586.527-3.586.528zm-73.934 1.055.95 1.898zm79.946 0h83.004l.527 1.476-1.477-.527h-82.054zm-77.942 2.953 2.004 2.953zm4.008 4.957 4.008 5.062zm7.91 8.016 4.008 5.062zM414.492 621l1.055 2.004zm76.992 2.004 2.532 1.476-1.477.528zm-74.988.95 1.055 2.003zm2.953 5.062 2.004 2.953zm84.059 0 .949 2.004zm4.957 2.004 1.055 2.003zm3.058.949.95 2.004zm2.954 1.054c1.582-.527 2.109 0 1.476 1.477zm-139.008.95 2.531 3.48-2.004-.95zm49.043 2.004.949 2.003zm4.008 5.062.949 2.004zm-47.989 2.004.95 2.004zm2.004 2.953 2.426 3.48-2.004-.949zM435.48 648l4.536 5.484-4.008-2.953zm-49.992 2.953 2.532 3.586h-1.055zm60.012 7.067 2.004 2.953zm-54 .949 1.477 2.531h-.95zm56.953 3.058h2.004c1.582-.527 2.11 0 1.582 1.477l4.43 3.48H459c-.738 1.793-.21 2.532 1.477 2.004l9.07 6.012 1.476-.527.528 1.476 1.476-.422.422 1.477 1.582-.527c-.527 1.582 0 2.109 1.477 1.476l8.965 4.008 1.476-.422c-.422 1.477.106 2.004 1.582 1.477l6.012 2.004 1.477-.528c-.528 1.793.316 2.215 2.53 1.477l1.477-.422-.527 1.476 4.008-1.054v2.004l4.957-.95v2.004c3.164.739 5.168.422 6.012-1.054v2.004l8.543.527-63.493 24.469-16.98-8.965-1.582.527.527-1.582-8.015-4.957-1.477.527.527-1.476-7.066-5.063-1.477.528-4.535-5.485-1.476.422-10.02-12.445zm-52.945 2.004.949 2.004c-1.793.422-2.11-.21-.95-2.004zm4.008 4.957 4.007 5.063-3.48-2.004zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
        <path
            style={{
                fill: "#d42642",
                fillOpacity: 1,
                fillRule: "nonzero",
                stroke: "#d42642",
                strokeWidth: 1,
                strokeLinecap: "butt",
                strokeLinejoin: "miter",
                strokeMiterlimit: 4,
                strokeOpacity: 1,
            }}
            d="m726.469 562.043.527 4.43h-.95zm-.95 8.965.528 2.531h-1.055zm-47.988 2.004-1.054 2.004zm46.934 2.953.527 2.531h-.949zm-50.942 2.004-1.054 2.004zm49.993 2.004.527 2.53h-1.055zm-55.055 2.004-.95 2.003zm51.996 8.015.527 1.477-3.48 6.539-.527-1.477zm-96.926 3.059 18.457.422-18.457.527zm92.918 5.906-.422 1.582c-4.535 9.176-10.652 16.664-18.562 22.465l-16.98 10.02-22.993 6.011h-10.02l-.949.95h-84.058v-.95h82.055l.949-1.055 16.98-.949c20.567-3.902 35.965-12.761 46.512-26.578zm-233.93 18.035.95 2.004zm41.028 18.985 2.426.527-2.426.527zm4.957 1.054 3.48.422-3.48.527zm6.96.95 6.54.527-6.54.527zm-104.94 5.062L434.53 648zm8.964 8.965 5.063 6.012zm8.016 6.96 2.004 3.06zm-54 3.06.95 2.003zm58.957.949 1.055 2.003zm3.059 2.003.949 2.004zm-59.063 1.055 2.004 2.953zm65.074 2.953.95 2.004zm2.953 2.004 5.485 3.48-1.477-.421c-2.637-.422-4.008-1.371-4.008-3.059zm-62.964 1.055 16.03 16.98zm73.933 4.957L486 681.539l-1.477.422-9.07-4.008zm12.024 4.957 7.488 2.531-2.426.528-5.062-2.004zm9.07 3.059 11.918 2.953 15.082 1.054.95.95h122.026l1.477 1.476.95 5.063-.95.949-.95 11.074-3.058 6.012-10.441 11.496c-4.43 2.953-9.703 4.957-16.031 5.906h-86.063l-.95-.95h-14.976l-1.054-1.054-14.028-.949-17.93-4.008-14.976-4.957c-16.242-6.539-30.375-14.976-42.504-25.523l3.48 2.531c9.282 7.066 19.618 12.973 31.008 17.93l63.493-24.47-19.512-2.53-6.961-2.004zm-77.098 4.007 4.008 4.957zm0 0"
            transform="matrix(.03704 0 0 .03704 -12.98 -12.829)"
        />
    </svg>
);

// SVG do Onvio como componente React
const OnvioSVG = (props) => (
    <svg width="20" height="30" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clipPath="url(#a)">
            <path d="M19.676 3.683c.29.29.45.677.45 1.086a1.539 1.539 0 0 1-2.622 1.086c-.29-.29-.45-.675-.45-1.086 0-.41.159-.796.45-1.086a1.532 1.532 0 0 1 2.172 0ZM3.06 20.312a1.538 1.538 0 0 1 1.086-2.622 1.539 1.539 0 0 1 0 3.072c-.41 0-.796-.159-1.086-.45ZM14.77 3.803l-.011-.004a1.328 1.328 0 0 1-.718-.724 1.342 1.342 0 0 1 1.757-1.757 1.345 1.345 0 0 1-1.029 2.485ZM7.459 20.093a1.345 1.345 0 1 1-.516 2.586 1.345 1.345 0 0 1 .514-2.587l.002.001ZM12.52 1.784c0 .618-.489 1.124-1.1 1.152h-.052a1.153 1.153 0 0 1 0-2.304c.635 0 1.152.519 1.152 1.154v-.002ZM10.215 22.216c0-.636.517-1.152 1.152-1.152.634 0 1.152.517 1.152 1.152 0 .635-.518 1.152-1.152 1.152a1.154 1.154 0 0 1-1.152-1.152ZM7.83 3.45a.96.96 0 0 1-1.256-.521.961.961 0 1 1 1.255.52ZM14.905 20.55a.967.967 0 0 1 .37-.074.953.953 0 0 1 .888.594.96.96 0 0 1-.521 1.256.963.963 0 0 1-1.257-1.256.946.946 0 0 1 .52-.52ZM4.688 4.237a.77.77 0 0 1 .015 1.072l-.017.017a.771.771 0 0 1-1.089-1.09.766.766 0 0 1 .545-.224c.198 0 .394.075.544.225h.002ZM18.04 18.679a.77.77 0 1 1-.002 0h.001ZM1.563 8.977a.962.962 0 1 1 .002 0h-.002ZM21.176 15.026a.96.96 0 1 1-.733 1.776.96.96 0 0 1 .733-1.776ZM0 12.006c0-.636.518-1.152 1.152-1.152.635 0 1.152.517 1.152 1.152 0 .635-.517 1.152-1.152 1.152A1.154 1.154 0 0 1 0 12.006ZM20.432 12.006c0-.636.518-1.152 1.152-1.152.635 0 1.152.517 1.152 1.152 0 .635-.517 1.152-1.152 1.152a1.154 1.154 0 0 1-1.152-1.152ZM.682 16.424a1.346 1.346 0 0 1 1.757-1.757 1.341 1.341 0 0 1 .728 1.757 1.342 1.342 0 0 1-1.757.728 1.342 1.342 0 0 1-.728-.728ZM19.559 8.604a1.34 1.34 0 0 1 .728-1.755c.166-.07.34-.104.511-.104a1.346 1.346 0 1 1-.513 2.586 1.342 1.342 0 0 1-.727-.727h.001ZM14.637 15.269a1.078 1.078 0 1 0 1.527 1.526 1.07 1.07 0 0 0 .317-.763c0-.288-.113-.56-.317-.762a1.08 1.08 0 0 0-1.524 0l-.003-.001Zm.037.037a1.024 1.024 0 1 0 1.451 1.45c.194-.194.3-.452.3-.725a1.023 1.023 0 0 0-1.749-.725h-.002ZM5.635 11.348a.855.855 0 1 1 1.045-.605.854.854 0 0 1-1.047.604h.002ZM16.656 14.301a.853.853 0 0 1-.604-1.048.852.852 0 0 1 .825-.635c.061 0 .123.006.183.02l.04.01a.856.856 0 0 1-.444 1.652v.001ZM5.196 13.653a.686.686 0 0 1 .446-.828l.039-.01a.685.685 0 1 1 .354 1.324.689.689 0 0 1-.84-.485l.001-.001ZM16.533 11.12l-.03-.017a.686.686 0 1 1 1.035-.753.685.685 0 0 1-1.005.77ZM7.715 16.368l-.02.02a.516.516 0 0 1-.728-.728.516.516 0 0 1 .748.708ZM15.762 7.6a.512.512 0 0 1 0 .73.516.516 0 1 1 0-.731V7.6ZM10.483 17.167a.685.685 0 1 1-.416-.319.68.68 0 0 1 .416.32v-.001ZM12.247 6.837a.685.685 0 1 1 1.186-.687.685.685 0 0 1-1.186.687ZM13.276 16.772l.036.021a.854.854 0 0 1-.243 1.544.852.852 0 0 1-.963-1.254.853.853 0 0 1 1.169-.313l.001.002ZM10.113 7.318a.855.855 0 1 1-.442-1.651.855.855 0 0 1 .441 1.651ZM7.334 9.036a1.077 1.077 0 1 0 0-2.154 1.077 1.077 0 0 0 0 2.154Z" fill="#D64000" />
        </g>
        <defs>
            <clipPath id="a">
                <path fill="#fff" transform="translate(0 .632)" d="M0 0h160.052v22.736H0z" />
            </clipPath>
        </defs>
    </svg>
);


// COMPONENTE LOCAL para anima√ß√£o do gr√°fico semicircular
const AnimatedCircularProgress = ({ value }) => {
    const props = useSpring({
        from: { val: 0 },
        to: { val: value },
        config: { tension: 120, friction: 20 },
    });

    return (
        <CircularProgressbarWithChildren
            value={value}
            maxValue={100}
            strokeWidth={10}
            styles={buildStyles({
                pathColor: 'url(#animatedGradient)',
                trailColor: '#1e1e2e',
                strokeLinecap: 'butt',
                rotation: 0.75,
            })}
            circleRatio={0.5}
        >
            <animated.div className={styles.performanceMesGraficoValor}>
                {props.val.to(n => `${Math.round(n)}%`)}
            </animated.div>
            <div className={styles.performanceMesGraficoLabel}>
                Tarefas Conclu√≠das
            </div>

            {/* Gradiente animado para o stroke */}
            <svg className={styles.hiddenSvgZeroHeight}>
                <defs>
                    <linearGradient id="animatedGradient" x1="0" x2="1" y1="0" y2="0">
                        <stop offset="0%" stopColor="#2EE5B6" />
                        <stop offset="100%" stopColor="#004CFF" />
                    </linearGradient>
                </defs>
            </svg>
        </CircularProgressbarWithChildren>
    );
};


function formatarCnpjCpf(cnpjCpf) {
    if (!cnpjCpf) return "";

    // Remove todos os caracteres n√£o num√©ricos
    const numeros = cnpjCpf.replace(/\D/g, "");

    // Verifica se √© CPF (11 d√≠gitos) ou CNPJ (14 d√≠gitos)
    if (numeros.length === 11) {
        // Formata CPF: 000.000.000-00
        return numeros.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
    } else if (numeros.length === 14) {
        // Formata CNPJ: 00.000.000/0000-00
        return numeros.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
    }

    // Se n√£o for nem CPF nem CNPJ, retorna o valor original
    return cnpjCpf;
}

const VisaoGeralModal = dynamic(() => import("../../components/gestao/VisaoGeralModal"), { ssr: false });

const Caixinha = ({ valor, onClick }) => (
    <button
        onClick={valor !== 0 ? onClick : undefined}
        className={`${styles.caixinhaBtn} ${valor === 0 ? styles.caixinhaBtnDisabled : ''}`}
    >
        {valor}
    </button>
);


// Tipagens removidas (arquivo JS)





export default function VisaoGeralPage() {
    const [usuarioDepartamento, setUsuarioDepartamento] = useState(null);
    const [usuarioLogado, setUsuarioLogado] = useState(null); // ‚úÖ Novo estado para usu√°rio logado
    const [autenticado, setAutenticado] = useState(false);
    const [departamentosDisponiveis, setDepartamentosDisponiveis] = useState([]); // lista √∫nica dos departamentos
    const [departamentosSelecionados, setDepartamentosSelecionados] = useState([]); // sele√ß√£o final aplicada
    const [selecoesTemporarias, setSelecoesTemporarias] = useState([]); // sele√ß√£o tempor√°ria no dropdown aberto
    const [dropdownDepartamentoAberto, setDropdownDepartamentoAberto] = useState(false); // para abrir/fechar o dropdown

    const [tarefasAbertas, setTarefasAbertas] = useState([]);
    const [modalAberto, setModalAberto] = useState(false);
    const [tituloModal, setTituloModal] = useState("");
    const [tarefasModal, setTarefasModal] = useState([]);
    const [obrigacoes, setObrigacoes] = useState([]); // Novo estado

    // Novos estados para Gest√£o de Documentos
    const [loadingDocumentos, setLoadingDocumentos] = useState(true);
    const [dadosSitFis, setDadosSitFis] = useState(null);
    const [dadosCertificados, setDadosCertificados] = useState(null);
    const [loadingTarefasAbertas, setLoadingTarefasAbertas] = useState(true);
    const [loadingObrigacoes, setLoadingObrigacoes] = useState(true);
    const [loadingPainelTarefas, setLoadingPainelTarefas] = useState(true);
    const [loadingPainelObrigacoes, setLoadingPainelObrigacoes] = useState(true);
    const [abaAtiva, setAbaAtiva] = useState("solicitacoes");
    const [painelObrigacoes, setPainelObrigacoes] = useState([]);
    const [painelTarefas, setPainelTarefas] = useState([]);
    const [painel, setPainel] = useState([]);
    const [clientesSelecionados, setClientesSelecionados] = useState([]);
    const [selecoesClientesTemp, setSelecoesClientesTemp] = useState([]);
    const [dropdownClienteAberto, setDropdownClienteAberto] = useState(false);
    const [buscaCliente, setBuscaCliente] = useState('');
    const [buscaDepartamento, setBuscaDepartamento] = useState('');
    const [dropdownGrupoAberto, setDropdownGrupoAberto] = useState(false);
    const [gruposDisponiveis, setGruposDisponiveis] = useState([]);
    const [gruposSelecionados, setGruposSelecionados] = useState([]);
    const [selecoesGruposTemp, setSelecoesGruposTemp] = useState([]);
    const [clientesPorGrupo, setClientesPorGrupo] = useState([]);
    const [loadingPesquisas, setLoadingPesquisas] = useState(false);
    const [dadosPesquisas, setDadosPesquisas] = useState(null);
    // Usu√°rios (Respons√°veis)
    const [usuariosDisponiveis, setUsuariosDisponiveis] = useState([]);
    const [usuariosSelecionados, setUsuariosSelecionados] = useState([]);
    const [selecoesUsuariosTemp, setSelecoesUsuariosTemp] = useState([]);
    const [dropdownUsuarioAberto, setDropdownUsuarioAberto] = useState(false);
    const [buscaUsuario, setBuscaUsuario] = useState("");


    const [buscaGrupo, setBuscaGrupo] = useState('');
    const router = useRouter();

    const [mesSelecionado, setMesSelecionado] = useState(new Date().getMonth());
    const [anoSelecionado, setAnoSelecionado] = useState(new Date().getFullYear());
    const [dropdownAtivo, setDropdownAtivo] = useState(null);

    const [clientesDisponiveis, setClientesDisponiveis] = useState([]);

    // Estados para o modal de PDF Layout
    const [modalPdfLayoutAberto, setModalPdfLayoutAberto] = useState(false);
    const [arquivosSelecionados, setArquivosSelecionados] = useState([]);
    const [processandoArquivo, setProcessandoArquivo] = useState(false);
    const [resultadoProcessamento, setResultadoProcessamento] = useState(null);
    const [dragActive, setDragActive] = useState(false);

    const [modalEcontador, setModalEcontador] = useState(false);
    const [loadingEcontador, setLoadingEcontador] = useState(false);
    const [resultadoEcontador, setResultadoEcontador] = useState(null);

    // Inicializa usu√°rio logado e departamento a partir do localStorage
    useEffect(() => {
      try {
        const raw = localStorage.getItem('userData');
        const u = raw ? JSON.parse(raw) : null;
        if (u) {
          setUsuarioLogado({ id: u.id, nome: u.nome, email: u.email });
          setUsuarioDepartamento(u.departamentoNome || u.departamento || null);
          setAutenticado(true);
        }
      } catch {}
    }, []);

    const [modalOnvio, setModalOnvio] = useState(false);
    const [loadingOnvio, setLoadingOnvio] = useState(false);
    const [resultadoOnvio, setResultadoOnvio] = useState(null);

    // Fun√ß√£o para iniciar a baixa autom√°tica do Onvio
    async function iniciarBaixaOnvio() {
        setLoadingOnvio(true);
        setResultadoOnvio(null);
        try {
            const token = getToken();
            const res = await fetch(`${BASE_URL}/gestao/onvio/baixar-atividades`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                throw { response: { status: res.status, data } };
            }
            setResultadoOnvio(data);
        } catch (error) {
            // üî• TRATAMENTO INTELIGENTE DE ERROS
            let mensagemErro = 'Erro ao processar a baixa autom√°tica.';

            if (error.response?.status === 400) {
                // Erro 400 - Credenciais n√£o configuradas
                if (error.response.data?.message?.includes('Credenciais da Onvio n√£o configuradas')) {
                    mensagemErro = 'Credenciais Onvio n√£o configuradas! √â necess√°rio configurar email e senha da Onvio para esta empresa.';
                } else if (error.response.data?.message?.includes('Empresa ID √© obrigat√≥rio')) {
                    mensagemErro = 'Empresa n√£o identificada. Fa√ßa login novamente.';
                } else {
                    mensagemErro = error.response.data?.message || 'Dados inv√°lidos para a opera√ß√£o.';
                }
            } else if (error.response?.status === 401) {
                mensagemErro = '‚ö†Ô∏è Sess√£o expirada. Fa√ßa login novamente.';
            } else if (error.response?.status === 403) {
                mensagemErro = '‚ö†Ô∏è Acesso negado. Verifique suas permiss√µes.';
            } else if (error.response?.status === 500) {
                mensagemErro = '‚ö†Ô∏è Erro interno do servidor. Tente novamente mais tarde.';
            } else if (error.code === 'NETWORK_ERROR' || error.message?.includes('Network Error')) {
                mensagemErro = '‚ö†Ô∏è Erro de conex√£o. Verifique sua internet e tente novamente.';
            }

            setResultadoOnvio({
                error: mensagemErro,
                tipo: 'erro',
                codigo: error.response?.status || 'unknown'
            });
        } finally {
            setLoadingOnvio(false);
        }
    }

    // Fun√ß√£o para iniciar a baixa autom√°tica do eContador
    async function iniciarBaixaEcontador() {
        setLoadingEcontador(true);
        setResultadoEcontador(null);
        try {
            const token = getToken();
            const res = await fetch(`${BASE_URL}/gestao/integracao-econtador/baixar-atividades`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                throw { response: { status: res.status, data } };
            }
            setResultadoEcontador(data);
        } catch (error) {
            // üî• TRATAMENTO INTELIGENTE DE ERROS
            let mensagemErro = 'Erro ao processar a baixa autom√°tica.';

            if (error.response?.status === 400) {
                // Erro 400 - Credenciais n√£o configuradas
                if (error.response.data?.message?.includes('Credenciais do eContador n√£o configuradas')) {
                    mensagemErro = 'Credenciais eContador n√£o configuradas! √â necess√°rio configurar as credenciais do eContador para esta empresa.';
                } else if (error.response.data?.message?.includes('Empresa ID √© obrigat√≥rio')) {
                    mensagemErro = 'Empresa n√£o identificada. Fa√ßa login novamente.';
                } else {
                    mensagemErro = error.response.data?.message || 'Dados inv√°lidos para a opera√ß√£o.';
                }
            } else if (error.response?.status === 401) {
                mensagemErro = '‚ö†Ô∏è Sess√£o expirada. Fa√ßa login novamente.';
            } else if (error.response?.status === 403) {
                mensagemErro = '‚ö†Ô∏è Acesso negado. Verifique suas permiss√µes.';
            } else if (error.response?.status === 500) {
                mensagemErro = '‚ö†Ô∏è Erro interno do servidor. Tente novamente mais tarde.';
            } else if (error.code === 'NETWORK_ERROR' || error.message?.includes('Network Error')) {
                mensagemErro = '‚ö†Ô∏è Erro de conex√£o. Verifique sua internet e tente novamente.';
            }

            setResultadoEcontador({
                error: mensagemErro,
                tipo: 'erro',
                codigo: error.response?.status || 'unknown'
            });
        } finally {
            setLoadingEcontador(false);
        }
    }

    const toggleDropdown = (index) => {
        if (dropdownAtivo === index) {
            setDropdownAtivo(null);
        } else {
            setDropdownAtivo(index);
        }
    };

    const avancarMes = () => {
        if (mesSelecionado === 11) {
            setMesSelecionado(0);
            setAnoSelecionado((prev) => prev + 1);
        } else {
            setMesSelecionado((prev) => prev + 1);
        }
    };

    const voltarMes = () => {
        if (mesSelecionado === 0) {
            setMesSelecionado(11);
            setAnoSelecionado((prev) => prev - 1);
        } else {
            setMesSelecionado((prev) => prev - 1);
        }
    };

    const dropdownRef = useRef(null);
    const dropdownGrupoRef = useRef(null);
    const dropdownPainelRef = useRef(null);



    useEffect(() => {
        function handleClickOutside(event) {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setDropdownDepartamentoAberto(false);
                setSelecoesTemporarias(departamentosSelecionados);
            }
        }
        if (dropdownDepartamentoAberto) {
            document.addEventListener("mousedown", handleClickOutside);
        } else {
            document.removeEventListener("mousedown", handleClickOutside);
        }
        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, [dropdownDepartamentoAberto, departamentosSelecionados]);

    useEffect(() => {
        if (dropdownDepartamentoAberto) {
            setSelecoesTemporarias(departamentosSelecionados);
        }
    }, [dropdownDepartamentoAberto]);

    useEffect(() => {
        function handleClickOutside(event) {
            if (dropdownGrupoRef.current && !dropdownGrupoRef.current.contains(event.target)) {
                setDropdownGrupoAberto(false);
            }
        }
        if (dropdownGrupoAberto) {
            document.addEventListener("mousedown", handleClickOutside);
        } else {
            document.removeEventListener("mousedown", handleClickOutside);
        }
        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, [dropdownGrupoAberto]);

    // Fechar dropdown do painel de controle ao clicar fora
    useEffect(() => {
        function handleClickOutside(event) {
            // Verifica se o clique foi fora do dropdown E n√£o foi no bot√£o que abre o dropdown
            const target = event.target;
            const isDropdownClick = dropdownPainelRef.current?.contains(target);
            const isButtonClick = event.target?.closest?.('.painelControleDepartamentoDropdownBtn');

            if (!isDropdownClick && !isButtonClick) {
                setDropdownAtivo(null);
            }
        }

        if (dropdownAtivo !== null) {
            document.addEventListener("mousedown", handleClickOutside);
        } else {
            document.removeEventListener("mousedown", handleClickOutside);
        }

        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, [dropdownAtivo]);

    function toggleSelecaoTemp(dep) {
        if (selecoesTemporarias.includes(dep)) {
            setSelecoesTemporarias(selecoesTemporarias.filter(d => d !== dep));
        } else {
            setSelecoesTemporarias([...selecoesTemporarias, dep]);
        }
    }

    function aplicarSelecao() {
        setDepartamentosSelecionados(selecoesTemporarias);
        setDropdownDepartamentoAberto(false);
    }

    function limparSelecao() {
        setSelecoesTemporarias([]);
    }

    function selecionarTodosDepartamentos() {
        // Se todos os departamentos j√° est√£o selecionados, desmarca todos
        if (selecoesTemporarias.length === departamentosDisponiveis.length) {
            setSelecoesTemporarias([]);
        } else {
            // Caso contr√°rio, seleciona todos
            setSelecoesTemporarias([...departamentosDisponiveis]);
        }
    }

    function extrairClienteId(item) {
        return item.clienteId || item.idCliente || item.cliente_id || item.id || null;
    }

    // Match por usu√°rio/respons√°vel em tarefa/obriga√ß√£o
    function matchUsuario(item) {
        if (usuariosSelecionados.length === 0) return true;
        const nomeDireto = item.responsavel_nome || item.responsavel || item.responsavelNome || item.responsavelDireto || "";
        if (nomeDireto && usuariosSelecionados.includes(String(nomeDireto))) return true;
        const lista = item.responsaveis || [];
        if (Array.isArray(lista) && lista.length > 0) {
            return lista.some((r) => {
                const n = r.responsavelNome || r.nome || r.usuarioNome || "";
                return n && usuariosSelecionados.includes(String(n));
            });
        }
        return false;
    }


    const tarefasGeradas = tarefasAbertas.filter((t) => {
        const total = t.atividades?.length || 0;
        const concluidasOuCanceladas = t.atividades?.filter((a) => a.concluida === 1 || a.cancelada === 1).length || 0;
        const clienteId = t.clienteId || t.idCliente || t.cliente_id || t.id; // <-- ID do cliente da tarefa

        return (
            (total === 0 || concluidasOuCanceladas < total) &&
            (departamentosSelecionados.length === 0 || departamentosSelecionados.includes(t.departamento)) &&
            (clientesSelecionados.length === 0 || clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) &&
            (gruposSelecionados.length === 0 || clientesPorGrupo.length === 0 || clientesPorGrupo.includes(clienteId)) &&
            matchUsuario(t)
        );
    });

    const obrigacoesGeradas = obrigacoes.filter((o) => {
        const total = o.atividades?.length || 0;
        const concluidas = o.atividades?.filter((a) => a.concluida === 1).length || 0;
        const isBaixadaAutomaticamente = o.baixadaAutomaticamente === 1;
        const clienteId = o.clienteId || o.idCliente || o.cliente_id || o.id;

        return (
            (total === 0 || concluidas < total || isBaixadaAutomaticamente) &&
            (departamentosSelecionados.length === 0 || departamentosSelecionados.includes(o.departamento_nome)) &&
            (clientesSelecionados.length === 0 || clientesSelecionados.includes(o.cliente_nome || o.cliente || "-")) &&
            (gruposSelecionados.length === 0 || clientesPorGrupo.length === 0 || clientesPorGrupo.includes(clienteId)) &&
            matchUsuario(o)
        );
    });

    const totalGeradas = tarefasGeradas
        .filter(t =>
            (departamentosSelecionados.length === 0 || departamentosSelecionados.includes(t.departamento)) &&
            (clientesSelecionados.length === 0 || clientesSelecionados.includes(t.cliente_nome || t.cliente || "-"))
        ).length
        +
        obrigacoesGeradas
            .filter(o =>
                (departamentosSelecionados.length === 0 || departamentosSelecionados.includes(o.departamento_nome)) &&
                (clientesSelecionados.length === 0 || clientesSelecionados.includes(o.cliente_nome || o.cliente || "-"))
            ).length;


    //UseEffect UNIFICADO para o performance do m√™s

    useEffect(() => {
        const token = getToken();
        const empresaId = getEmpresaId();
        if (!token || !empresaId || !usuarioLogado) return; // ‚úÖ Aguarda usu√°rio estar carregado

        setLoadingTarefasAbertas(true);
        setLoadingObrigacoes(true);

    const headers = { Authorization: `Bearer ${token}` };
    const certHeaders = { Authorization: `Bearer ${token}`, 'X-Empresa-Id': String(empresaId) };
        const usuarioId = usuarioLogado.id; // ‚úÖ Obt√©m o ID do usu√°rio logado

        // ‚úÖ Verificar se h√° filtros ativos (grupos, clientes ou departamentos)
        const filtrosAtivos = departamentosSelecionados.length > 0 ||
            clientesSelecionados.length > 0 ||
            gruposSelecionados.length > 0;

        console.log(`üîç [Frontend] Carregando dados para usu√°rio ID: ${usuarioId}, filtrosAtivos: ${filtrosAtivos}`);

        // ‚úÖ Construir URLs com par√¢metros condicionais
        const urlTarefas = `/gestao/tarefas/todas/${empresaId}?usuarioId=${usuarioId}&filtrosAtivos=${filtrosAtivos}`;
        const urlObrigacoes = `/gestao/obrigacoes/empresa/${empresaId}/todas?usuarioId=${usuarioId}&filtrosAtivos=${filtrosAtivos}`;

        Promise.all([
            api.get(urlTarefas, { headers }), // ‚úÖ Inclui filtro e flag de filtros ativos
            api.get(urlObrigacoes, { headers }), // ‚úÖ Inclui filtro e flag de filtros ativos
            api.get(`/usuarios`, { headers })
        ])
            .then(([resTarefas, resObrigacoes, resUsuarios]) => {
                const tarefas = Array.isArray(resTarefas.data) ? resTarefas.data : [];
                const obrigacoes = Array.isArray(resObrigacoes.data) ? resObrigacoes.data : [];
                console.log(`‚úÖ [Frontend] Tarefas carregadas: ${tarefas.length}, Obriga√ß√µes: ${obrigacoes.length}`);
                setTarefasAbertas(tarefas);
                setObrigacoes(obrigacoes);
                const users = Array.isArray(resUsuarios.data) ? resUsuarios.data : [];
                // Somente usu√°rios com departamento definido
                setUsuariosDisponiveis(
                    users
                        .filter((u) => (u.departamentoNome && String(u.departamentoNome).trim() !== ""))
                        .map((u) => ({ id: u.id, nome: u.nome, departamentoNome: u.departamentoNome }))
                );
            })
            .catch((err) => {
                console.error("‚ùå [Frontend] Erro ao carregar dados:", err);
                setTarefasAbertas([]);
                setObrigacoes([]);
            })
            .finally(() => {
                setLoadingTarefasAbertas(false);
                setLoadingObrigacoes(false);
            });
    }, [usuarioLogado, departamentosSelecionados, clientesSelecionados, gruposSelecionados]); // ‚úÖ Recarrega quando filtros mudam


    // ‚úÖ NOVO ‚Äì Painel Tarefas
    useEffect(() => {
        const token = getToken();
        const empresaId = getEmpresaId();
        if (!token || !empresaId || !usuarioLogado) return; // ‚úÖ Aguarda usu√°rio estar carregado

        setLoadingPainelTarefas(true);
        setLoadingPainelObrigacoes(true);

        const usuarioId = usuarioLogado.id; // ‚úÖ Obt√©m o ID do usu√°rio logado

        // ‚úÖ Verificar se h√° filtros ativos (grupos, clientes ou departamentos)
        const filtrosAtivos = departamentosSelecionados.length > 0 ||
            clientesSelecionados.length > 0 ||
            gruposSelecionados.length > 0;

        console.log(`üîç [Frontend] Carregando pain√©is para usu√°rio ID: ${usuarioId}, filtrosAtivos: ${filtrosAtivos}`);

        // ‚úÖ Construir URLs com par√¢metros condicionais
        const urlPainelTarefas = `/gestao/tarefas/painel-controle/${empresaId}?usuarioId=${usuarioId}&filtrosAtivos=${filtrosAtivos}&mes=${mesSelecionado}&ano=${anoSelecionado}`;
        const urlPainelObrigacoes = `/gestao/obrigacoes/empresa/${empresaId}/geradas/painel?usuarioId=${usuarioId}&filtrosAtivos=${filtrosAtivos}&mes=${mesSelecionado}&ano=${anoSelecionado}`;

        const fetchPainelTarefas = api
            .get(urlPainelTarefas, { // ‚úÖ Inclui filtro e flag de filtros ativos
                headers: { Authorization: `Bearer ${token}` },
            })
            .then((res) => {
                console.log(`‚úÖ [Frontend] Painel Tarefas carregado: ${res.data?.length || 0} departamentos`);
                setPainelTarefas(res.data || []);
            })
            .catch((err) => {
                console.error("‚ùå [Frontend] Erro ao carregar painel de tarefas:", err);
                setPainelTarefas([]);
            })
            .finally(() => setLoadingPainelTarefas(false));

        const fetchPainelObrigacoes = api
            .get(urlPainelObrigacoes, { // ‚úÖ Inclui filtro e flag de filtros ativos
                headers: { Authorization: `Bearer ${token}` },
            })
            .then((res) => {
                console.log(`‚úÖ [Frontend] Painel Obriga√ß√µes carregado: ${res.data?.length || 0} departamentos`);
                setPainelObrigacoes(res.data || []);
            })
            .catch((err) => {
                console.error("‚ùå [Frontend] Erro ao carregar painel de obriga√ß√µes:", err);
                setPainelObrigacoes([]);
            })
            .finally(() => setLoadingPainelObrigacoes(false));

        Promise.all([fetchPainelTarefas, fetchPainelObrigacoes]);
    }, [usuarioLogado, departamentosSelecionados, clientesSelecionados, gruposSelecionados, mesSelecionado, anoSelecionado]); // ‚úÖ Recarrega quando filtros ou m√™s/ano mudam


    useEffect(() => {
        const token = getToken();
        const empresaId = getEmpresaId();
        if (!token || !empresaId) return;

        fetch(`${BASE_URL}/gestao/clientes/grupos/todos?empresaId=${empresaId}`, { headers: { Authorization: `Bearer ${token}` } })
            .then(r => r.json())
            .then(res => {
                const gruposNormalizados = (res.grupos || []).map((grupo) => ({
                    ...grupo,
                    nome: grupo.nome.toLowerCase()
                        .split(' ')
                        .map((palavra) => palavra.charAt(0).toUpperCase() + palavra.slice(1))
                        .join(' ')
                }));
                setGruposDisponiveis(gruposNormalizados);
            })
            .catch(() => setGruposDisponiveis([]));
    }, []);


    //UseEffect de CLIENTES
    useEffect(() => {
        if (!dropdownClienteAberto) return;
        const empresaId = getEmpresaId();
        const token = getToken();
        if (!empresaId || !token) return;

        if (gruposSelecionados.length > 0) {
            Promise.all(
                gruposSelecionados.map(grupoId =>
                    fetch(`${BASE_URL}/gestao/clientes/grupo/${grupoId}`, { headers: { Authorization: `Bearer ${token}` } }).then(r => r.json())
                )
            ).then(resArr => {
                const todosClientes = resArr.flatMap(res => res.clientes || []);
                const clientesUnicos = [];
                const idsVistos = new Set();
                for (const cli of todosClientes) {
                    if (!idsVistos.has(cli.id)) {
                        clientesUnicos.push(cli);
                        idsVistos.add(cli.id);
                    }
                }
                setClientesDisponiveis(clientesUnicos);
                // S√≥ setClientesSelecionados aqui SE o filtro foi aberto manualmente
                if (dropdownClienteAberto && gruposSelecionados.length > 0) {
                    setClientesSelecionados(clientesUnicos.map(c => c.nome));
                    setClientesPorGrupo(clientesUnicos.map(c => c.id));
                }
                setClientesPorGrupo(clientesUnicos.map(c => c.id));

                // ATUALIZA A SELE√á√ÉO DE CLIENTES PARA O FILTRO FUNCIONAR AUTOMATICAMENTE
                setClientesSelecionados(clientesUnicos.map(c => c.nome)); // Usar o nome aqui porque seu filtro filtra por nome

            }).catch(() => {
                // console.error("Erro ao buscar clientes por grupos");
                setClientesDisponiveis([]);
                setClientesSelecionados([]);  // Limpa sele√ß√£o se der erro
                setClientesPorGrupo([]);
            });
            return;
        }

        // Se nenhum grupo selecionado, busca todos os clientes da empresa normalmente
        const busca = buscaCliente.trim();
        const timeout = setTimeout(() => {
            fetch(`${BASE_URL}/gestao/clientes/todos/${empresaId}${busca ? `?busca=${encodeURIComponent(busca)}` : ''}`, {
                headers: { Authorization: `Bearer ${token}` }
            })
                .then((r) => r.json())
                .then((res) => {
                    setClientesDisponiveis(res.clientes || []);
                    setClientesSelecionados([]); // Limpa sele√ß√£o para "todos" quando n√£o tem grupo selecionado
                    setClientesPorGrupo([]);
                })
                .catch(() => {
                    setClientesDisponiveis([]);
                    setClientesSelecionados([]);
                    setClientesPorGrupo([]);
                });
        }, 400);

        return () => clearTimeout(timeout);
    }, [dropdownClienteAberto, buscaCliente, gruposSelecionados]);




  useEffect(() => {
    const tarefasPanel = Array.isArray(painelTarefas) ? painelTarefas : [];
    const obrigPanel = Array.isArray(painelObrigacoes) ? painelObrigacoes : [];
    if (tarefasPanel.length === 0 && obrigPanel.length === 0) return;

        // ‚úÖ FILTRAR DEPARTAMENTOS: Mostrar apenas onde o usu√°rio tem tarefas/obriga√ß√µes
        // (quando n√£o h√° filtros ativos - grupos, clientes ou departamentos)
        const filtrosAtivos = departamentosSelecionados.length > 0 ||
            clientesSelecionados.length > 0 ||
            gruposSelecionados.length > 0;

        let departamentosParaMostrar;

    if (filtrosAtivos) {
            // ‚úÖ COM FILTROS: Mostrar todos os departamentos (comportamento original)
            departamentosParaMostrar = [
        ...new Set([
          ...tarefasPanel.map((d) => d.departamento),
          ...obrigPanel.map((d) => d.departamento),
        ]),
            ];
            console.log(`üîç [Painel] Filtros ativos - mostrando TODOS os departamentos: ${departamentosParaMostrar.length}`);
        } else {
            // ‚úÖ SEM FILTROS: Mostrar apenas departamentos onde o usu√°rio tem tarefas/obriga√ß√µes
      const departamentosComTarefas = tarefasPanel
                .filter(d => d.acao.tarefas.length > 0 || d.atencao.tarefas.length > 0 || d.concluidas.tarefas.length > 0)
                .map(d => d.departamento);

      const departamentosComObrigacoes = obrigPanel
                .filter(d => d.acao.tarefas.length > 0 || d.atencao.tarefas.length > 0 || d.concluidas.tarefas.length > 0)
                .map(d => d.departamento);

            departamentosParaMostrar = [
                ...new Set([
                    ...departamentosComTarefas,
                    ...departamentosComObrigacoes,
                ]),
            ];
            console.log(`üë§ [Painel] Sem filtros - mostrando apenas departamentos com atividades: ${departamentosParaMostrar.length}`);
            console.log(`üìä [Painel] Departamentos com tarefas: ${departamentosComTarefas.length}, com obriga√ß√µes: ${departamentosComObrigacoes.length}`);
        }

        // ‚úÖ Popula o estado dos departamentos dispon√≠veis para o filtro dropdown
        // (sempre todos os departamentos para o filtro funcionar)
    const todosDepartamentos = [
      ...new Set([
        ...tarefasPanel.map((d) => d.departamento),
        ...obrigPanel.map((d) => d.departamento),
      ]),
    ];
        setDepartamentosDisponiveis(todosDepartamentos);

    const painelUnificado = departamentosParaMostrar.map((depNome) => {
      const depTarefa = tarefasPanel.find((d) => d.departamento === depNome);
      const depObrigacao = obrigPanel.find((d) => d.departamento === depNome);

            const mergeValores = (a = {}, b = {}) => {
                return {
                    ...a,
                    proximos15dias: (a?.proximos15dias || 0) + (b?.proximos15dias || 0),
                    programadoHoje: (a?.programadoHoje || 0) + (b?.programadoHoje || 0),
                    foraProgramado: (a?.foraProgramado || 0) + (b?.foraProgramado || 0),
                    aposMeta: (a?.aposMeta || 0) + (b?.aposMeta || 0),
                    venceHoje: (a?.venceHoje || 0) + (b?.venceHoje || 0),
                    aposPrazo: (a?.aposPrazo || 0) + (b?.aposPrazo || 0),
                    finalizada: (a?.finalizada || 0) + (b?.finalizada || 0),
                    naProgramacao: (a?.naProgramacao || 0) + (b?.naProgramacao || 0),
                    concluidasAposMetaPrazo: (a?.concluidasAposMetaPrazo || 0) + (b?.concluidasAposMetaPrazo || 0),
                    tarefas: [
                        ...(a?.tarefas || []).map((t) => ({
                            ...t,
                            categoria: t.tipo, // ‚úÖ Use o que o backend j√° mandou
                            tipo: "tarefa",
                            cliente_nome: t.cliente_nome || t.cliente || "-",
                            status_cliente: t.status_cliente || t.statusCliente || "-",
                            assunto: t.assunto || t.nome || "-",
                            departamento: t.departamento || depNome || "-",
                            atividades: t.atividades || [],
                            status: t.status || "pendente"
                        })),
                        ...(b?.tarefas || []).map((t) => ({
                            ...t,
                            tipo: "obrigacao",
                            categoria: t.categoria || t.tipo,
                            cliente: t.cliente || t.cliente_nome || "-",
                            statusCliente: t.statusCliente || t.status_cliente || "-",
                            assunto: t.assunto || t.nome || "-",
                            departamento: t.departamento || t.departamento_nome || depNome || "-",
                            atividades: t.atividades || [],
                            status: t.status || "pendente"
                        })),
                    ]
                };
            };


            return {
                departamento: depNome,
                acao: mergeValores(depTarefa?.acao, depObrigacao?.acao),
                atencao: mergeValores(depTarefa?.atencao, depObrigacao?.atencao),
                concluidas: mergeValores(depTarefa?.concluidas, depObrigacao?.concluidas),
            };
        });

        // Ordena os departamentos alfabeticamente (exceto o do usu√°rio que vai para o topo)
        const painelOrdenado = [...painelUnificado];

        // Primeiro, ordena alfabeticamente todos os departamentos
        painelOrdenado.sort((a, b) => a.departamento.localeCompare(b.departamento, 'pt-BR'));

        // Depois, move o departamento do usu√°rio para o topo (se existir)
        if (usuarioDepartamento) {
            const idx = painelOrdenado.findIndex(p => p.departamento === usuarioDepartamento);
            if (idx !== -1) {
                const [depUsuario] = painelOrdenado.splice(idx, 1);
                painelOrdenado.unshift(depUsuario);
            }
        }
        let painelUsuario = null;

        if (usuarioDepartamento) {
            const idx = painelUnificado.findIndex(p => p.departamento === usuarioDepartamento);
            if (idx !== -1) {
                [painelUsuario] = painelUnificado.splice(idx, 1); // remove e guarda separado
            }
        }

        setPainel(painelOrdenado);
        // console.timeEnd("PainelObrigacoes: Render"); // LOG
    }, [painelTarefas, painelObrigacoes]);

    // useEffect para carregar dados de documentos
    useEffect(() => {
        const token = getToken();
        const empresaId = getEmpresaId();
        if (!token || !empresaId) return;

        setLoadingDocumentos(true);

        const headers = { Authorization: `Bearer ${token}` };

    // Verificar se tem permiss√£o para visualizar certificados
    const podeVerCert = hasPermissaoCertificado("visualizar");
    console.log("[VisaoGeral] permiss√£o certificados (visualizar):", podeVerCert);
    if (podeVerCert) {
      // Logs detalhados de status e payload para debug
      Promise.all([
        fetch(`${BASE_URL}/gestao/sitfis/${empresaId}`, { headers }).then(async (r) => {
          const body = await r.json().catch(() => null);
          console.log('[VisaoGeral][sitfis] status:', r.status, 'body:', body);
          return body;
        }),
        fetch(`${BASE_URL}/gestao/escritorio/certificados-clientes?ordenacao=vencimento`, { headers: { Authorization: `Bearer ${token}`, 'X-Empresa-Id': String(empresaId) } }).then(async (r) => {
          const body = await r.json().catch(() => null);
          console.log('[VisaoGeral][certificados] status:', r.status, 'body:', body);
          return body;
        })
      ])
        .then(([resSitFis, resCertificados]) => {
          setDadosSitFis(Array.isArray(resSitFis) ? resSitFis : []);
          setDadosCertificados(Array.isArray(resCertificados) ? resCertificados : []);
          console.log("[VisaoGeral] sitfis size:", Array.isArray(resSitFis) ? resSitFis.length : resSitFis,
                      "certificados size:", Array.isArray(resCertificados) ? resCertificados.length : resCertificados);
        })
        .catch((error) => {
          if (error?.response?.status !== 403) {
            console.error("Erro ao carregar dados de documentos:", error);
          }
        })
        .finally(() => {
          setLoadingDocumentos(false);
        });
        } else {
            // Se n√£o tem permiss√£o, s√≥ carrega sitfis
      fetch(`${BASE_URL}/gestao/sitfis/${empresaId}`, { headers })
                .then((r) => r.json())
                .then((resSitFis) => {
                    setDadosSitFis(resSitFis);
                    setDadosCertificados([]);
          console.log("[VisaoGeral] sem permiss√£o certificados, sitfis size:", Array.isArray(resSitFis) ? resSitFis.length : resSitFis);
                })
                .catch((error) => {
                    if (error?.response?.status !== 403) {
                        console.error("Erro ao carregar dados de documentos:", error);
                    }
                })
                .finally(() => {
                    setLoadingDocumentos(false);
                });
        }
    }, []);

    // useEffect para carregar dados de pesquisas de satisfa√ß√£o
    useEffect(() => {
        const token = getToken();
        const empresaId = getEmpresaId();
        if (!token || !empresaId) return;

        setLoadingPesquisas(true);

        const headers = { Authorization: `Bearer ${token}` };

        // Primeiro, verificar se a empresa √© franqueadora
        api.get(`/gestao/pesquisa/franqueadora/estatisticas/${empresaId}`, { headers })
            .then((res) => {
                if (res.data.isFranqueadora) {
                    // Empresa √© franqueadora - usar estat√≠sticas dos franqueados
                    const dadosFranqueados = res.data;
                    setDadosPesquisas({
                        isFranqueadora: true,
                        totalEnviadas: dadosFranqueados.total_respostas,
                        totalRespondidas: dadosFranqueados.total_respostas,
                        totalSatisfeitos: dadosFranqueados.salas.verde + dadosFranqueados.salas.amarela,
                        totalDetratores: dadosFranqueados.salas.vermelha,
                        totalNeutros: dadosFranqueados.salas.amarela,
                        taxaResposta: 100, // Todas as pesquisas respondidas s√£o contadas
                        taxaSatisfacao: dadosFranqueados.taxa_satisfacao,
                        salas: dadosFranqueados.salas
                    });
                } else {
                    // Empresa n√£o √© franqueadora - usar estat√≠sticas de clientes
                    return api.get(`/gestao/pesquisa/clientes/estatisticas/${empresaId}`, { headers });
                }
            })
            .then((res) => {
                if (res && !res.data.isFranqueadora) {
                    // Processar estat√≠sticas de clientes
                    const dadosClientes = res.data;

                    if (dadosClientes.pesquisaAtiva) {
                        const totalSatisfeitos = dadosClientes.salas.verde + dadosClientes.salas.amarela;
                        const totalDetratores = dadosClientes.salas.vermelha;
                        const totalNeutros = dadosClientes.salas.amarela;
                        const taxaResposta = dadosClientes.total_envios > 0 ?
                            Math.round((dadosClientes.total_respostas / dadosClientes.total_envios) * 100) : 0;

                        setDadosPesquisas({
                            isFranqueadora: false,
                            pesquisaAtiva: true,
                            totalEnviadas: dadosClientes.total_envios,
                            totalRespondidas: dadosClientes.total_respostas,
                            totalSatisfeitos,
                            totalDetratores,
                            totalNeutros,
                            taxaResposta,
                            taxaSatisfacao: dadosClientes.taxa_satisfacao,
                            notaMedia: dadosClientes.nota_media,
                            salas: dadosClientes.salas
                        });
                    } else {
                        setDadosPesquisas({
                            isFranqueadora: false,
                            pesquisaAtiva: false,
                            totalEnviadas: 0,
                            totalRespondidas: 0,
                            totalSatisfeitos: 0,
                            totalDetratores: 0,
                            totalNeutros: 0,
                            taxaResposta: 0,
                            taxaSatisfacao: 0
                        });
                    }
                }
            })
            .catch((error) => {
                console.error("Erro ao carregar dados de pesquisas:", error);
                setDadosPesquisas(null);
            })
            .finally(() => {
                setLoadingPesquisas(false);
            });
    }, []);




    function LegendaCores() {
        const [aberto, setAberto] = useState(false);
        const [altura, setAltura] = useState(0);
        const conteudoRef = useRef(null);

        const legenda = [
            { cor: "#fbbf24", texto: "Pr√≥ximos 15 dias" },
            { cor: "#f59e0b", texto: "Programado Hoje" },
            { cor: "#6b7280", texto: "Fora do Programado" },
            { cor: "#dc2626", texto: "Ap√≥s Meta" },
            { cor: "#ea580c", texto: "Vence Hoje" },
            { cor: "#b91c1c", texto: "Ap√≥s Prazo" },
            { cor: "#22c55e", texto: "Na Programa√ß√£o" },
            { cor: "#059669", texto: "Conclu√≠da Ap√≥s Meta" },
            { cor: "#7c3aed", texto: "Conclu√≠da Ap√≥s Prazo" }
        ];


        useEffect(() => {
            if (aberto && conteudoRef.current) {
                setAltura(conteudoRef.current.scrollHeight);
            } else {
                setAltura(0);
            }
        }, [aberto]);

        return (
            <div className={styles.legendaWrapper}>
                {/* T√≠tulo Legendas */}
                <div
                    className={styles.legendaTitulo}
                    onClick={() => setAberto(!aberto)}
                >
                    <span>Legendas</span>
                    <svg
                        className={styles.legendaIcon}
                        style={{
                            transform: aberto ? "rotate(180deg)" : "rotate(0deg)",
                        }}
                        fill="none"
                        stroke="#334155"
                        strokeWidth="2"
                        viewBox="0 0 24 24"
                    >
                        <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                {/* Container animado */}
                <div
                    className={styles.legendaContainerAnimado}
                    style={{
                        height: altura,
                        opacity: aberto ? 1 : 0,
                    }}
                >
                    <div
                        ref={conteudoRef}
                        className={styles.legendaConteudo}
                    >
                        {legenda.map((item, idx) => (
                            <div key={idx} className={styles.legendaItem}>
                                <div
                                    className={styles.caixinhaLegenda}
                                    style={{ backgroundColor: item.cor }}
                                >
                                    <div className={styles.tooltip}>
                                        {item.texto}
                                    </div>
                                </div>
                                <span className={styles.legendaTexto}>{item.texto}</span>
                            </div>
                        ))}
                    </div>
                </div>

                {/* CSS Global para hover dos tooltips */}
                <style jsx global>{`
          .caixinha-legenda:hover .tooltip {
  visibility: visible;
  opacity: 1;
}
        `}</style>
            </div>
        );
    }

    const legendaCores = {
        proximos15dias: "#fbbf24", // amarelo vibrante
        programadoHoje: "#f59e0b", // laranja vibrante
        foraProgramado: "#6b7280", // cinza mais escuro
        aposMeta: "#dc2626", // vermelho vibrante
        venceHoje: "#ea580c", // laranja vermelho
        aposPrazo: "#b91c1c", // vermelho escuro
        finalizada: "#16a34a", // verde vibrante
        naProgramacao: "#22c55e", // verde claro
        conclAposMeta: "#059669", // verde esmeralda
        conclAposPrazo: "#7c3aed", // violeta vibrante
    };


    const celulaTrio = (
        valores,
        cores,
        labels,
        tarefas,
        abrirModal,
        tipo = "action"
    ) => {
        return (
            <div className={styles.celulaTrioWrapper}>
                {valores.map((valor, i) => (
                    <div
                        key={i}
                        className={`${styles.celulaIndividual} ${valor > 0 ? "" : styles.inativo}`}
                        onClick={() => valor > 0 && abrirModal(labels[i], tarefas[i])}
                        style={{
                            cursor: valor > 0 ? "pointer" : "default",
                            borderColor: valor > 0 ? cores[i] : "#666",
                            color: valor > 0 ? "#fff" : "#666",
                            borderWidth: "2px",
                            borderStyle: "solid",
                        }}
                        title={labels[i]}
                    >
                        {valor}
                        {valor > 0 && (
                            <div className={styles.tooltipCaixinha}>
                                {labels[i]}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        );
    };

    const hoje = new Date().toISOString().split("T")[0];

    const normalizarDatas = (item = {}) => ({
        dataAcao: item.dataAcao || item.data_acao || item.acaoData || item.dataAcaoPrevista || null,
        dataMeta: item.dataMeta || item.data_meta || item.metaData || item.dataMetaPrevista || null,
        dataPrazo: item.dataPrazo || item.data_prazo || item.prazo || item.dataPrazoPrevista || null,
        vencimento: item.vencimento || item.vencimentoData || item.dataPrazo || item.data_prazo || null,
    });

    function abrirModal(
        titulo,
        tarefas = [],
        obrigacoesExtras = [],
        departamento,
        abaInicial = "solicitacoes"
    ) {
        const tarefasFormatadas = tarefas.map((tarefa) => {
            const datasNormalizadas = normalizarDatas(tarefa);
            return {
                ...tarefa,
                ...datasNormalizadas,
                departamento: departamento || tarefa.departamento || tarefa.departamento_nome || "-",
                status: tarefa.status || "pendente",
                tipo: tarefa.tipo || "tarefa",
                atividades: tarefa.atividades || [],
                cliente_cnpj: tarefa.cliente_cnpj || tarefa.clienteCnpj || tarefa.cnpj || null,
            };
        });

        const obrigacoesFormatadas = (obrigacoesExtras || [])
            .filter((ob) => ob && typeof ob === "object" && Object.keys(ob).length > 0)
            .map((ob) => {
                const datasNormalizadas = normalizarDatas(ob);
                return {
                    ...ob,
                    ...datasNormalizadas,
                    tipo: "obrigacao",
                    departamento: ob.departamento_nome || ob.departamento || departamento || "-",
                    cliente: ob.cliente_nome || ob.cliente || "-",
                    statusCliente: ob.status_cliente || ob.statusCliente || "-",
                    status: ob.status || "pendente",
                    atividades: ob.atividades || [],
                    assunto: ob.assunto || ob.nome || "-", // üëà ESSA LINHA AQUI
                    baixadaAutomaticamente: ob.baixadaAutomaticamente,
                    cliente_cnpj: ob.cliente_cnpj || ob.clienteCnpj || ob.cnpj || null,
                };
            });




        const totalItens = tarefasFormatadas.length + obrigacoesFormatadas.length;

        if (totalItens === 0) return;

        setTituloModal(titulo);

        if (tarefasFormatadas.length > 0 && obrigacoesFormatadas.length === 0) {
            setAbaAtiva("solicitacoes");
        } else if (obrigacoesFormatadas.length > 0 && tarefasFormatadas.length === 0) {
            setAbaAtiva("obrigacoes");
        } else {
            setAbaAtiva(abaInicial); // mant√©m o valor inicial quando h√° mistura
        }

        // console.log("DEBUG - Tarefas concluidas agrupadas:", painel.map(dep => ({
        //   departamento: dep.departamento,
        //   tarefasConcluidas: dep.concluidas.tarefas.map(t => ({
        //     id: t.id,
        //     categoria: t.categoria,
        //     assunto: t.assunto,
        //     tipo: t.tipo,
        //     status: t.status
        //   }))
        // })));


        setTarefasModal([...tarefasFormatadas, ...obrigacoesFormatadas]);
        setModalAberto(true);
    }


    function calcularProgresso(atividades) {
        if (!atividades || atividades.length === 0) return 0;
        const concluidasOuCanceladas = atividades.filter((a) => a.concluida === 1 || a.cancelada === 1).length;
        return Math.round((concluidasOuCanceladas / atividades.length) * 100);
    }


    const tarefasDoMes = tarefasAbertas
        .filter((t) => {
            // Normaliza campos vindos do endpoint "todas" (snake_case)
            const rawPrazo = t.dataPrazo || t.data_prazo || t.prazo;
            if (!rawPrazo) return false;
            const prazo = new Date(rawPrazo);
            if (isNaN(prazo.getTime())) return false;
            return prazo.getMonth() === mesSelecionado &&
                prazo.getFullYear() === anoSelecionado &&
                (departamentosSelecionados.length === 0 || departamentosSelecionados.includes(t.departamento || t.departamento_nome)) &&
                (clientesSelecionados.length === 0 || clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) &&
                matchUsuario(t);
        });

    const obrigacoesDoMes = obrigacoes.filter((o) => {
        const venc = o.vencimento || o.dataPrazo;
        if (!venc) return false;
        const dataVencimento = venc.split("T")[0];
        const [ano, mes] = dataVencimento.split("-");
        return (
            Number(ano) === anoSelecionado &&
            Number(mes) === mesSelecionado + 1 &&
            (departamentosSelecionados.length === 0 || departamentosSelecionados.includes(o.departamento_nome)) &&
            (clientesSelecionados.length === 0 || clientesSelecionados.includes(o.cliente_nome || o.cliente || "-")) &&
            matchUsuario(o)
        );
    });

    // ‚úÖ CORRIGIDO: L√≥gica para evitar duplica√ß√£o entre realizadas e pendentes
    const tarefasRealizadas = [
        ...tarefasDoMes.filter(t => {
            const total = t.atividades?.length || 0;
            const concluidas = t.atividades?.filter((a) => (a.concluida === 1 || a.concluido === 1) || (a.cancelada === 1 || a.cancelado === 1)).length || 0;

            return (
                (t.status?.toLowerCase && t.status?.toLowerCase() === "conclu√≠da") ||
                t.baixadaAutomaticamente === 1 ||
                (total > 0 && concluidas === total)
            );
        }),
        ...obrigacoesDoMes.filter(o => {
            const total = o.atividades?.length || 0;
            const concluidas = o.atividades?.filter((a) => a.concluida === 1 || a.cancelada === 1).length || 0;

            // ‚úÖ CORRIGIDO: Obriga√ß√µes s√≥ v√£o para "Tarefas Realizadas" quando:
            //  - Status "concluida" na tabela obrigacoes_clientes
            //  - OU baixada automaticamente
            return (
                o.baixadaAutomaticamente === 1 ||
                o.status?.toLowerCase() === "concluida"
            );
        })
    ];



    const tarefasPendentes = tarefasDoMes.filter((t) => {
        // ‚úÖ CORRIGIDO: Exclui tarefas que j√° foram realizadas
        if (t.baixadaAutomaticamente === 1) return false;  // Exclui baixadas automaticamente
        if (t.status?.toLowerCase && t.status?.toLowerCase() === "conclu√≠da") return false; // ‚úÖ Exclui com status conclu√≠da

        const total = t.atividades?.length || 0;
        const concluidas = t.atividades?.filter((a) => (a.concluida === 1 || a.concluido === 1) || (a.cancelada === 1 || a.cancelado === 1)).length || 0;

        // ‚úÖ S√≥ √© pendente se ainda h√° atividades n√£o conclu√≠das
        return total === 0 || concluidas < total;
    }).map((t) => ({ ...t, tipo: "tarefa" }));

    const obrigacoesPendentes = obrigacoesDoMes.filter((o) => {
        const total = o.atividades?.length || 0;
        const concluidasOuCanceladas = o.atividades?.filter((a) => a.concluida === 1 || a.cancelada === 1).length || 0;

        // ‚úÖ CORRIGIDO: Obriga√ß√µes s√£o pendentes se:
        //  - N√£o foi baixada automaticamente
        //  - N√ÉO est√° com status "concluida" na tabela obrigacoes_clientes
        return (
            o.baixadaAutomaticamente !== 1 &&
            o.status?.toLowerCase() !== "concluida"
        );
    });





    // ‚úÖ CORRIGIDO: C√°lculos sem duplica√ß√£o
    const totalRealizadas = tarefasRealizadas.length;
    const totalPendentes = tarefasPendentes.length + obrigacoesPendentes.length;
    const total = totalRealizadas + totalPendentes;

    // ‚úÖ Valida√ß√£o para garantir que n√£o h√° duplica√ß√£o
    if (total !== tarefasDoMes.length + obrigacoesDoMes.length) {
        console.warn("‚ö†Ô∏è Poss√≠vel duplica√ß√£o detectada na contagem de tarefas:", {
            totalCalculado: total,
            totalReal: tarefasDoMes.length + obrigacoesDoMes.length,
            tarefasRealizadas: tarefasRealizadas.length,
            tarefasPendentes: tarefasPendentes.length,
            obrigacoesPendentes: obrigacoesPendentes.length
        });
    }

    const percentualConcluido = total > 0
        ? Math.round((totalRealizadas / total) * 100)
        : 0;

    const abrirCliente = () => {
        setDropdownClienteAberto((prev) => {
            if (!prev) {
                setDropdownDepartamentoAberto(false);
                setDropdownUsuarioAberto(false);
            }
            // Sempre que abrir, carrega as sele√ß√µes j√° aplicadas
            setSelecoesClientesTemp(clientesSelecionados);
            return !prev;
        });
    };
    const abrirDepartamento = () => {
        setDropdownDepartamentoAberto((prev) => {
            if (!prev) setDropdownClienteAberto(false);
            return !prev;
        });
    };

    // Fun√ß√µes para o modal de PDF Layout
    const handleDrag = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (e.type === "dragenter" || e.type === "dragover") {
            setDragActive(true);
        } else if (e.type === "dragleave") {
            setDragActive(false);
        }
    };

    const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragActive(false);

        if (e.dataTransfer.files) {
            const files = Array.from(e.dataTransfer.files);
            const pdfFiles = files.filter(file => file.type === "application/pdf");
            setArquivosSelecionados(pdfFiles);
        }
    };

    const handleFileSelect = (e) => {
        if (e.target.files) {
            const files = Array.from(e.target.files);
            const pdfFiles = files.filter(file => file.type === "application/pdf");
            setArquivosSelecionados(pdfFiles);
        }
    };

    const processarArquivos = async () => {
        if (arquivosSelecionados.length === 0) return;

        setProcessandoArquivo(true);
        setResultadoProcessamento(null);

        try {
            const formData = new FormData();
            arquivosSelecionados.forEach(arquivo => {
                formData.append('pdfs', arquivo);
            });

            const token = getToken();
            const empresaId = getEmpresaId();

            if (!token || !empresaId) {
                throw new Error("Token ou empresaId n√£o encontrado");
            }

            // Processar os arquivos em lote
            const response = await api.post('/pdf-layouts/processar-pdf-lote', formData, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'empresaId': empresaId,
                    'Content-Type': 'multipart/form-data',
                },
            });

            setResultadoProcessamento(response.data);

            // Limpar arquivos ap√≥s processamento
            setArquivosSelecionados([]);

        } catch (error) {
            console.error("Erro ao processar arquivos:", error);
            setResultadoProcessamento({
                sucesso: false,
                mensagem: error.response?.data?.mensagem || error.message || "Erro ao processar arquivos"
            });
        } finally {
            setProcessandoArquivo(false);
        }
    };

    const fecharModalPdfLayout = () => {
        setModalPdfLayoutAberto(false);
        setArquivosSelecionados([]);
        setProcessandoArquivo(false);
        setResultadoProcessamento(null);
        setDragActive(false);
    };


    // Estilo base para os cards resumo superiores
    const cardResumoStyle = {
        borderRadius: "12px",
        padding: "20px",
        color: "#fff",
        display: "flex",
        alignItems: "center",
        gap: "16px",
        boxShadow: "0 2px 4px rgba(0,0,0,0.1)",
        transition: "transform 0.18s, box-shadow 0.18s",
        cursor: "pointer",
        minHeight: "80px"
    };

    // Carregar dados de documentos
    const carregarDadosDocumentos = async () => {
        try {
            // Verificar se tem permiss√£o para visualizar certificados
            if (hasPermissaoCertificado("visualizar")) {
                const headers = {
                    'Content-Type': 'application/json',
                };

                const [resCertificados] = await Promise.all([
                    api.get(`/gestao/escritorio/certificados-clientes`, { headers })
                ]);

                setDadosCertificados(resCertificados.data);
            } else {
                setDadosCertificados([]);
            }
        } catch (error) {
            // N√£o logar erros 403 - s√£o esperados quando n√£o h√° permiss√µes
            if (error.response?.status !== 403) {
                console.error("Erro ao carregar dados de documentos:", error);
            }
            setDadosCertificados([]);
        }
    };

    return (
        <>
            <PrincipalSidebar />
            <div className={styles.layoutRoot}>
                <div className={styles.layoutContent}>
                    <main className={styles.mainContent}>
                        <div className={styles.filtrosWrapper}>

                            {/* Filtro Grupo */}
                            <div className={styles.filtroGrupoWrapper}>
                                <button
                                    onClick={() => {
                                        setDropdownGrupoAberto((prev) => {
                                            if (!prev) {
                                                setDropdownClienteAberto(false);
                                                setDropdownDepartamentoAberto(false);
                                            }
                                            return !prev;
                                        });
                                    }}
                                    className={`${styles.filtroGrupoBtn} ${(dropdownGrupoAberto || gruposSelecionados.length > 0) ? styles.ativo : ""}`}
                                >
                                    {gruposSelecionados.length === 0
                                        ? "Grupos"
                                        : gruposSelecionados.length === 1
                                            ? gruposDisponiveis.find(g => g.id === gruposSelecionados[0])?.nome || "Grupo"
                                            : `${gruposSelecionados.length} grupos`}
                                    <span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
                                            <polyline points="6 9 12 15 18 9" />
                                        </svg>
                                    </span>
                                </button>
                                {dropdownGrupoAberto && (
                                    <div
                                        ref={dropdownGrupoRef}
                                        className={styles.filtroGrupoDropdown}
                                    >
                                        <div className={styles.filtroGrupoDropdownInputWrapper}>
                                            <input
                                                type="text"
                                                placeholder="Pesquisar grupo"
                                                autoFocus
                                                value={buscaGrupo}
                                                onChange={e => setBuscaGrupo(e.target.value)}
                                                className={styles.filtroGrupoDropdownInput}
                                            />
                                        </div>
                                        <div className={styles.filtroGrupoDropdownList}>
                                            {gruposDisponiveis
                                                .filter(g => g.nome.toLowerCase().includes(buscaGrupo.toLowerCase()))
                                                .map((g) => (
                                                    <label
                                                        key={g.id}
                                                        className={styles.filtroGrupoDropdownLabel}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={selecoesGruposTemp.includes(g.id)}
                                                            onChange={() => {
                                                                if (selecoesGruposTemp.includes(g.id)) {
                                                                    setSelecoesGruposTemp(selecoesGruposTemp.filter(id => id !== g.id));
                                                                } else {
                                                                    setSelecoesGruposTemp([...selecoesGruposTemp, g.id]);
                                                                }
                                                            }}
                                                        />
                                                        <span>
                                                            <div className={styles.filtroGrupoDropdownLabelNome}>{g.nome}</div>
                                                        </span>
                                                    </label>
                                                ))}
                                        </div>
                                        <div className={styles.filtroGrupoDropdownFooter}>
                                            <button
                                                onClick={() => setSelecoesGruposTemp([])}
                                                className={styles.filtroGrupoDropdownBtnLimpar}
                                            >
                                                Limpar
                                            </button>
                                            <button
                                                onClick={async () => {
                                                    setGruposSelecionados(selecoesGruposTemp);
                                                    setDropdownGrupoAberto(false);
                                                    setBuscaGrupo("");

                                                    // NOVO: Busca clientes dos grupos selecionados automaticamente
                                                    const empresaId = getEmpresaId();
                                                    const token = getToken();
                                                    if (empresaId && token && selecoesGruposTemp.length > 0) {
                                                        try {
                                                            // Busca de todos os grupos selecionados
                                                            const resArr = await Promise.all(
                                                                selecoesGruposTemp.map(grupoId =>
                                                                    fetch(`${BASE_URL}/gestao/clientes/grupo/${grupoId}`, { headers: { Authorization: `Bearer ${token}` } }).then(r => r.json())
                                                                )
                                                            );
                                                            const todosClientes = resArr.flatMap((res) => res.clientes || []);
                                                            const clientesUnicos = [];
                                                            const idsVistos = new Set();
                                                            for (const cli of todosClientes) {
                                                                if (!idsVistos.has(cli.id)) {
                                                                    clientesUnicos.push(cli);
                                                                    idsVistos.add(cli.id);
                                                                }
                                                            }
                                                            // Seta os nomes dos clientes no filtro
                                                            setClientesSelecionados(clientesUnicos.map(c => c.nome));
                                                            setClientesPorGrupo(clientesUnicos.map(c => c.id));
                                                            setClientesDisponiveis(clientesUnicos);
                                                        } catch (e) {
                                                            setClientesSelecionados([]);
                                                            setClientesPorGrupo([]);
                                                            setClientesDisponiveis([]);
                                                        }
                                                    } else if (empresaId && token && selecoesGruposTemp.length === 0) {
                                                        // Se desmarcou todos os grupos, limpa sele√ß√£o de cliente tamb√©m
                                                        setClientesSelecionados([]);
                                                        setClientesPorGrupo([]);
                                                        // Busca todos clientes da empresa
                                                        try {
                                                            const r = await fetch(`${BASE_URL}/gestao/clientes/todos/${empresaId}`, { headers: { Authorization: `Bearer ${token}` } });
                                                            const res = await r.json();
                                                            setClientesDisponiveis(res.clientes || []);
                                                        } catch (e) {
                                                            setClientesDisponiveis([]);
                                                        }
                                                    }
                                                }}
                                                className={styles.filtroGrupoDropdownBtnAplicar}
                                            >
                                                Aplicar
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Filtro Cliente */}
                            <div className={styles.filtroClienteWrapper}>
                                <button
                                    onClick={abrirCliente}
                                    className={`${styles.filtroClienteBtn} ${(dropdownClienteAberto || clientesSelecionados.length > 0) ? styles.ativo : ""}`}
                                >
                                    {clientesSelecionados.length === 0
                                        ? "Clientes"
                                        : clientesSelecionados.length === 1
                                            ? clientesSelecionados[0]
                                            : `${clientesSelecionados.length} clientes`}
                                    <span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
                                            <polyline points="6 9 12 15 18 9" />
                                        </svg>
                                    </span>
                                </button>
                                {dropdownClienteAberto && (
                                    <div className={styles.filtroClienteDropdown}>
                                        <div className={styles.filtroClienteDropdownInputWrapper}>
                                            <input
                                                type="text"
                                                placeholder="Pesquisar"
                                                autoFocus
                                                value={buscaCliente}
                                                onChange={e => setBuscaCliente(e.target.value)}
                                                className={styles.filtroClienteDropdownInput}
                                            />
                                        </div>
                                        {/* Lista de clientes com scroll */}
                                        <div className={styles.filtroClienteDropdownList}>
                                            {clientesDisponiveis.map((c) => (
                                                <label
                                                    key={c.id}
                                                    className={styles.filtroClienteDropdownLabel}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={selecoesClientesTemp.includes(c.nome)}
                                                        onChange={() => {
                                                            if (selecoesClientesTemp.includes(c.nome)) {
                                                                setSelecoesClientesTemp(selecoesClientesTemp.filter(n => n !== c.nome));
                                                            } else {
                                                                setSelecoesClientesTemp([...selecoesClientesTemp, c.nome]);
                                                            }
                                                        }}
                                                        className={styles.filtroClienteCheckbox}
                                                    />
                                                    <span>
                                                        <div className={styles.filtroClienteDropdownLabelNome}>{c.nome}</div>
                                                        <div className={styles.filtroClienteDropdownLabelCnpj}>
                                                            {c.cnpjCpf
                                                                ? formatarCnpjCpf(c.cnpjCpf)
                                                                : <span className={styles.filtroClienteDropdownLabelCnpjVermelho}></span>
                                                            }
                                                        </div>
                                                    </span>
                                                </label>
                                            ))}
                                        </div>
                                        {/* Fim da lista scroll */}
                                        <div className={styles.filtroClienteDropdownFooter}>
                                            <button
                                                onClick={() => setSelecoesClientesTemp([])}
                                                className={styles.filtroClienteDropdownBtnLimpar}
                                            >
                                                Limpar
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setClientesSelecionados(selecoesClientesTemp);
                                                    setDropdownClienteAberto(false);
                                                    setBuscaCliente("");
                                                }}
                                                className={styles.filtroClienteDropdownBtnAplicar}
                                            >
                                                Aplicar
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Filtro Respons√°vel */}
                            <div className={styles.filtroClienteWrapper}>
                                <button
                                    onClick={() => setDropdownUsuarioAberto(prev => {
                                        if (!prev) { setDropdownDepartamentoAberto(false); setDropdownClienteAberto(false); setDropdownGrupoAberto(false); }
                                        setSelecoesUsuariosTemp(usuariosSelecionados);
                                        return !prev;
                                    })}
                                    className={`${styles.filtroClienteBtn} ${(dropdownUsuarioAberto || usuariosSelecionados.length > 0) ? styles.ativo : ""}`}
                                >
                                    {usuariosSelecionados.length === 0
                                        ? "Respons√°veis"
                                        : usuariosSelecionados.length === 1
                                            ? usuariosSelecionados[0]
                                            : `${usuariosSelecionados.length} respons√°veis`}
                                    <span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
                                            <polyline points="6 9 12 15 18 9" />
                                        </svg>
                                    </span>
                                </button>
                                {dropdownUsuarioAberto && (
                                    <div className={styles.filtroClienteDropdown}>
                                        <div className={styles.filtroClienteDropdownInputWrapper}>
                                            <input
                                                type="text"
                                                placeholder="Pesquisar respons√°vel"
                                                autoFocus
                                                value={buscaUsuario}
                                                onChange={e => setBuscaUsuario(e.target.value)}
                                                className={styles.filtroClienteDropdownInput}
                                            />
                                        </div>
                                        {(() => {
                                            const usuariosFiltrados = usuariosDisponiveis.filter(u =>
                                                (buscaUsuario.trim() === "" || u.nome.toLowerCase().includes(buscaUsuario.toLowerCase())) &&
                                                (departamentosSelecionados.length === 0 || !u.departamentoNome || departamentosSelecionados.includes(u.departamentoNome))
                                            );
                                            const todosSelecionados = usuariosFiltrados.length > 0 && usuariosFiltrados.every(u => selecoesUsuariosTemp.includes(u.nome));
                                            return (
                                                <div className={styles.filtroClienteDropdownList}>
                                                    {/* Selecionar Todos */}
                                                    <label
                                                        className={styles.filtroClienteDropdownLabel}
                                                        style={{ borderBottom: '1px solid #e5e7eb', paddingBottom: '8px', marginBottom: '8px', fontWeight: 600 }}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={todosSelecionados}
                                                            onChange={() => {
                                                                if (todosSelecionados) {
                                                                    // desmarca todos da lista filtrada
                                                                    const nomesFiltrados = usuariosFiltrados.map(u => u.nome);
                                                                    setSelecoesUsuariosTemp(selecoesUsuariosTemp.filter(n => !nomesFiltrados.includes(n)));
                                                                } else {
                                                                    // adiciona todos da lista filtrada
                                                                    const nomesFiltrados = usuariosFiltrados.map(u => u.nome);
                                                                    const setAtual = new Set(selecoesUsuariosTemp);
                                                                    nomesFiltrados.forEach(n => setAtual.add(n));
                                                                    setSelecoesUsuariosTemp(Array.from(setAtual));
                                                                }
                                                            }}
                                                            className={styles.filtroClienteCheckbox}
                                                        />
                                                        Selecionar Todos
                                                    </label>

                                                    {usuariosFiltrados.map((u) => (
                                                        <label key={u.id} className={styles.filtroClienteDropdownLabel}>
                                                            <input
                                                                type="checkbox"
                                                                checked={selecoesUsuariosTemp.includes(u.nome)}
                                                                onChange={() => {
                                                                    if (selecoesUsuariosTemp.includes(u.nome)) {
                                                                        setSelecoesUsuariosTemp(selecoesUsuariosTemp.filter(n => n !== u.nome));
                                                                    } else {
                                                                        setSelecoesUsuariosTemp([...selecoesUsuariosTemp, u.nome]);
                                                                    }
                                                                }}
                                                                className={styles.filtroClienteCheckbox}
                                                            />
                                                            <span>
                                                                <div className={styles.filtroClienteDropdownLabelNome}>{u.nome}</div>
                                                                {u.departamentoNome && (
                                                                    <div className={styles.filtroClienteDropdownLabelCnpj}>
                                                                        {u.departamentoNome}
                                                                    </div>
                                                                )}
                                                            </span>
                                                        </label>
                                                    ))}
                                                </div>
                                            );
                                        })()}
                                        <div className={styles.filtroClienteDropdownFooter}>
                                            <button onClick={() => setSelecoesUsuariosTemp([])} className={styles.filtroClienteDropdownBtnLimpar}>
                                                Limpar
                                            </button>
                                            <button onClick={() => { setUsuariosSelecionados(selecoesUsuariosTemp); setDropdownUsuarioAberto(false); setBuscaUsuario(""); }} className={styles.filtroClienteDropdownBtnAplicar}>
                                                Aplicar
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Filtro Departamento */}
                            <div className={styles.filtroDepartamentoWrapper} style={{ marginLeft: "12px" }}>
                                <button
                                    onClick={abrirDepartamento}
                                    className={`${styles.filtroDepartamentoBtn} ${(dropdownDepartamentoAberto || departamentosSelecionados.length > 0) ? styles.ativo : ""}`}
                                >
                                    {departamentosSelecionados.length === 0
                                        ? "Departamentos"
                                        : departamentosSelecionados.length === 1
                                            ? departamentosSelecionados[0]
                                            : `${departamentosSelecionados.length} departamentos`}
                                    <span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
                                            <polyline points="6 9 12 15 18 9" />
                                        </svg>
                                    </span>
                                </button>
                                {dropdownDepartamentoAberto && (
                                    <div
                                        ref={dropdownRef}
                                        className={styles.filtroDepartamentoDropdown}
                                    >
                                        <div className={styles.filtroDepartamentoDropdownInputWrapper}>
                                            <input
                                                type="text"
                                                placeholder="Pesquisar"
                                                autoFocus
                                                value={buscaDepartamento}
                                                onChange={e => setBuscaDepartamento(e.target.value)}
                                                className={styles.filtroDepartamentoDropdownInput}
                                            />
                                        </div>
                                        {/* Lista com maxHeight para scroll */}
                                        <div className={styles.filtroDepartamentoDropdownList}>
                                            {/* Op√ß√£o "Selecionar Todos" */}
                                            <label
                                                className={styles.filtroDepartamentoDropdownLabel}
                                                style={{
                                                    borderBottom: '1px solid #e5e7eb',
                                                    paddingBottom: '8px',
                                                    marginBottom: '8px',
                                                    fontWeight: '600'
                                                }}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={selecoesTemporarias.length === departamentosDisponiveis.length && departamentosDisponiveis.length > 0}
                                                    onChange={selecionarTodosDepartamentos}
                                                    className={styles.filtroDepartamentoCheckbox}
                                                />
                                                Selecionar Todos
                                            </label>

                                            {departamentosDisponiveis
                                                .filter(dep =>
                                                    dep.toLowerCase().includes(buscaDepartamento.toLowerCase())
                                                )
                                                .map((dep) => (
                                                    <label
                                                        key={dep}
                                                        className={styles.filtroDepartamentoDropdownLabel}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={selecoesTemporarias.includes(dep)}
                                                            onChange={() => toggleSelecaoTemp(dep)}
                                                            className={styles.filtroDepartamentoCheckbox}
                                                        />
                                                        {dep}
                                                    </label>
                                                ))}
                                        </div>
                                        {/* Fim da lista scroll */}
                                        <div className={styles.filtroDepartamentoDropdownFooter}>
                                            <button
                                                onClick={limparSelecao}
                                                className={styles.filtroDepartamentoDropdownBtnLimpar}
                                            >
                                                Limpar
                                            </button>
                                            <button
                                                onClick={() => {
                                                    aplicarSelecao();
                                                    setDropdownDepartamentoAberto(false);
                                                    setBuscaDepartamento("");
                                                }}
                                                className={styles.filtroDepartamentoDropdownBtnAplicar}
                                            >
                                                Aplicar
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* === CARDS RESUMO SUPERIOR === */}
                        <div className={styles.cardsResumoGrid}>

                            {/* Card Vencem Hoje */}
                            <div
                                className={`${styles.cardResumo} ${styles.cardResumoGlow}`}
                                style={{ "--grad-start": "rgba(248,113,113,0.25)", "--grad-end": "rgba(190,18,60,0.25)" }}
                            >
                                <div className={styles.cardResumoIconGlow} style={{ backgroundColor: "#F87171" }}>
                                    <FiCalendar />
                                </div>
                                <div>
                                    <div className={styles.cardResumoTituloGlow}>Vencem Hoje</div>
                                    {(loadingPainelTarefas || loadingPainelObrigacoes) ? (
                                        <div className={styles.cardResumoValorCarregando}>Carregando...</div>
                                    ) : (
                                        <div
                                            className={styles.cardResumoValorGlow}
                                            style={{ color: "#F87171", cursor: "pointer" }}
                                            title="Clique para ver detalhes"
                                            onClick={() => {
                                                const hojeStr = new Date().toISOString().split("T")[0];
                                                const tarefasHoje = tarefasAbertas.filter(
                                                    t => t.dataPrazo?.split("T")[0] === hojeStr && String(t.status).toLowerCase() === 'aberta'
                                                );
                                                const obrigacoesHoje = obrigacoes.filter(o => {
                                                    const venc = o.vencimento || o.dataPrazo;
                                                    return venc?.split("T")[0] === hojeStr && String(o.status).toLowerCase() === 'pendente';
                                                });
                                                abrirModal("Vencem Hoje", tarefasHoje, obrigacoesHoje, undefined, "obrigacoes");
                                            }}
                                        >
                                            {painel
                                                .filter(dep => departamentosSelecionados.length === 0 || departamentosSelecionados.includes(dep.departamento))
                                                .reduce((acc, item) => acc + item.atencao.venceHoje, 0)}
                                        </div>
                                    )}
                                </div>
                            </div>



                            {/* Card Tarefas Geradas */}
                            <div
                                className={`${styles.cardResumo} ${styles.cardResumoGlow}`}
                                style={{ "--grad-start": "rgba(96,165,250,0.25)", "--grad-end": "rgba(59,130,246,0.25)" }}
                            >
                                <div className={styles.cardResumoIconGlow} style={{ backgroundColor: "#3B82F6" }}>
                                    <FiRefreshCw />
                                </div>
                                {(loadingTarefasAbertas || loadingObrigacoes) ? (
                                    <div>
                                        <div className={styles.cardResumoTituloGlow}>Tarefas Geradas</div>
                                        <div className={styles.cardResumoValorCarregando}>Carregando...</div>
                                    </div>
                                ) : (
                                    <div
                                        style={{ cursor: totalGeradas > 0 ? "pointer" : "default" }}
                                        onClick={() =>
                                            totalGeradas > 0 &&
                                            abrirModal(
                                                "Tarefas Geradas",
                                                tarefasGeradas.filter(
                                                    t =>
                                                        (departamentosSelecionados.length === 0 || departamentosSelecionados.includes(t.departamento)) &&
                                                        (clientesSelecionados.length === 0 || clientesSelecionados.includes(t.cliente_nome || t.cliente || "-"))
                                                ),
                                                obrigacoesGeradas.filter(
                                                    o =>
                                                        (departamentosSelecionados.length === 0 || departamentosSelecionados.includes(o.departamento_nome)) &&
                                                        (clientesSelecionados.length === 0 || clientesSelecionados.includes(o.cliente_nome || o.cliente || "-"))
                                                ),
                                                undefined,
                                                "solicitacoes"
                                            )
                                        }
                                    >
                                        <div className={styles.cardResumoTituloGlow}>Tarefas Geradas</div>
                                        <div className={styles.cardResumoValorGlow} style={{ color: "#60A5FA" }}>{totalGeradas}</div>
                                    </div>
                                )}
                            </div>

                            {/* Card Taxa de Satisfa√ß√£o */}
                            <div
                                className={`${styles.cardResumo} ${styles.cardResumoGlow}`}
                                style={{ "--grad-start": "rgba(34,211,238,0.25)", "--grad-end": "rgba(6,182,212,0.25)" }}
                            >
                                <div className={styles.cardResumoIconGlow} style={{ backgroundColor: "#06B6D4" }}>
                                    <FiHeart />
                                </div>
                                <div>
                                    <div className={styles.cardResumoTituloGlow}>Taxa de Satisfa√ß√£o</div>
                                    {loadingPesquisas ? (
                                        <div className={styles.cardResumoValorCarregando}>Carregando...</div>
                                    ) : (
                                        <div className={styles.cardResumoValorGlow} style={{ color: "#22D3EE" }}>
                                            {dadosPesquisas?.taxaSatisfacao || 0}%
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>


                        {/* === GEST√ÉO DE DOCUMENTOS === */}
                        <div className={styles.gestaoDocumentosGrid}>
                            {/* Card Situa√ß√£o Fiscal */}
                            <div className={styles.cardGestaoDoc}>
                                <h2 className={styles.cardGestaoDocTitulo}>Situa√ß√£o Fiscal</h2>
                                {loadingDocumentos ? (
                                    <div className={styles.cardGestaoDocLoading}>
                                        <div className={styles.cardGestaoDocLoadingIcon}>
                                            <SpinnerGlobal size={40} variant="gradient" />
                                        </div>
                                        <div className={styles.cardGestaoDocLoadingText}>Carregando dados...</div>
                                    </div>
                                ) : (
                                    <div className={styles.cardGestaoDocResumoCol}>
                                        <div className={styles.cardGestaoDocResumoLinha}>
                                            <span className={styles.cardGestaoDocResumoLabel}>Total</span>
                                            <span className={styles.cardGestaoDocResumoValor}>
                                                {dadosSitFis?.reduce((total, item) => total + item.total, 0) || 0}
                                            </span>
                                        </div>
                                        <div className={styles.cardGestaoDocResumoLinha}>
                                            <span className={styles.cardGestaoDocResumoLabel}>Regulares</span>
                                            <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVerde}`}>
                                                {dadosSitFis?.find((item) => item.status === "Regular")?.total || 0}
                                            </span>
                                        </div>
                                        <div className={styles.cardGestaoDocResumoLinha}>
                                            <span className={styles.cardGestaoDocResumoLabel}>Irregulares</span>
                                            <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVermelho}`}>
                                                {dadosSitFis?.find((item) => item.status === "Irregular")?.total || 0}
                                            </span>
                                        </div>
                                        <div className={styles.cardGestaoDocResumoLinha}>
                                            <span className={styles.cardGestaoDocResumoLabel}>Regularizados</span>
                                            <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorAmarelo}`}>
                                                {dadosSitFis?.find((item) => item.status === "Regularizado")?.total || 0}
                                            </span>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Card Certificados */}
                            <div className={styles.cardGestaoDoc}>
                                <h2 className={styles.cardGestaoDocTitulo}>Certificados</h2>
                                {loadingDocumentos ? (
                                    <div className={styles.cardGestaoDocLoading}>
                                        <div className={styles.cardGestaoDocLoadingIcon}>
                                            <SpinnerGlobal size={40} variant="gradient" />
                                        </div>
                                        <div className={styles.cardGestaoDocLoadingText}>Carregando dados...</div>
                                    </div>
                                ) : (
                                    <div className={styles.cardGestaoDocResumoCol}>
                                        <div className={styles.cardGestaoDocResumoLinha}>
                                            <span className={styles.cardGestaoDocResumoLabel}>Total</span>
                                            <span className={styles.cardGestaoDocResumoValor}>
                                                {dadosCertificados?.length || 0}
                                            </span>
                                        </div>
                                        <div className={styles.cardGestaoDocResumoLinha}>
                                            <span className={styles.cardGestaoDocResumoLabel}>Regulares</span>
                                            <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVerde}`}>
                                                {dadosCertificados?.filter((cert) => {
                                                    const vencimento = new Date(cert.dataVencimento);
                                                    const hoje = new Date();
                                                    const diffDias = Math.ceil((vencimento.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24));
                                                    return diffDias > 30;
                                                }).length || 0}
                                            </span>
                                        </div>
                                        <div className={styles.cardGestaoDocResumoLinha}>
                                            <span className={styles.cardGestaoDocResumoLabel}>Vencem em 30 dias</span>
                                            <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorAmarelo}`}>
                                                {dadosCertificados?.filter((cert) => {
                                                    const vencimento = new Date(cert.dataVencimento);
                                                    const hoje = new Date();
                                                    const diffDias = Math.ceil((vencimento.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24));
                                                    return diffDias <= 30 && diffDias > 0;
                                                }).length || 0}
                                            </span>
                                        </div>
                                        <div className={styles.cardGestaoDocResumoLinha}>
                                            <span className={styles.cardGestaoDocResumoLabel}>Vencidos</span>
                                            <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVermelho}`}>
                                                {dadosCertificados?.filter((cert) => {
                                                    const vencimento = new Date(cert.dataVencimento);
                                                    const hoje = new Date();
                                                    return vencimento < hoje;
                                                }).length || 0}
                                            </span>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Card Pesquisa de Satisfa√ß√£o */}
                            <div className={styles.cardGestaoDoc}>
                                <div className={styles.cardPesquisaHeader}>
                                    <h2 className={styles.cardGestaoDocTitulo}>
                                        {dadosPesquisas?.isFranqueadora ? 'Pesquisa de Satisfa√ß√£o' : 'Pesquisa de Satisfa√ß√£o'}
                                    </h2>
                                    {dadosPesquisas?.isFranqueadora && hasPermissao("anjos", "visualizar") && (
                                        <button
                                            onClick={() => window.open('/dashboard/satisfacao-franqueados', '_blank')}
                                            className={styles.pesquisaLinkBtn}
                                            title="Ver Dashboard de Satisfa√ß√£o dos Franqueados"
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                <path d="M3 3v18h18" />
                                                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" />
                                                <path d="M9 10l3 3 7-7" />
                                            </svg>
                                        </button>
                                    )}
                                    {!dadosPesquisas?.isFranqueadora && (
                                        <button
                                            onClick={() => window.open('/gestao/satisfacao-clientes', '_blank')}
                                            className={styles.pesquisaLinkBtn}
                                            title="Ver Dashboard de Satisfa√ß√£o dos Clientes"
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                <path d="M3 3v18h18" />
                                                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" />
                                                <path d="M9 10l3 3 7-7" />
                                            </svg>
                                        </button>
                                    )}
                                </div>
                                {loadingPesquisas ? (
                                    <div className={styles.cardGestaoDocLoading}>
                                        <div className={styles.cardGestaoDocLoadingIcon}>
                                            <SpinnerGlobal size={40} variant="gradient" />
                                        </div>
                                        <div className={styles.cardGestaoDocLoadingText}>
                                            Carregando dados...
                                        </div>
                                    </div>
                                ) : dadosPesquisas ? (
                                    <div className={styles.cardGestaoDocResumoCol}>
                                        {dadosPesquisas.isFranqueadora ? (
                                            // Interface para franqueadoras
                                            <>
                                                {/* Total Respostas */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Total de Respostas</span>
                                                    <span className={styles.cardGestaoDocResumoValor}>{dadosPesquisas.totalRespondidas}</span>
                                                </div>

                                                {/* Taxa de Satisfa√ß√£o */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Taxa de Satisfa√ß√£o</span>
                                                    <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVerde}`}>{dadosPesquisas.taxaSatisfacao}%</span>
                                                </div>

                                                {/* Sala Verde */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Sala Verde</span>
                                                    <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVerde}`}>{dadosPesquisas.salas?.verde || 0}</span>
                                                </div>

                                                {/* Sala Amarela */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Sala Amarela</span>
                                                    <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorAmarelo}`}>{dadosPesquisas.salas?.amarela || 0}</span>
                                                </div>

                                                {/* Sala Vermelha */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Sala Vermelha</span>
                                                    <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVermelho}`}>{dadosPesquisas.salas?.vermelha || 0}</span>
                                                </div>
                                            </>
                                        ) : (
                                            // Interface para empresas normais
                                            <>
                                                {/* Total Enviadas */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Pesquisas Enviadas</span>
                                                    <span className={styles.cardGestaoDocResumoValor}>{dadosPesquisas.totalEnviadas}</span>
                                                </div>

                                                {/* Total Respondidas */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Respostas Recebidas</span>
                                                    <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVerde}`}>{dadosPesquisas.totalRespondidas}</span>
                                                </div>

                                                {/* Taxa de Resposta */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Taxa de Resposta</span>
                                                    <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorAzul}`}>{dadosPesquisas.taxaResposta}%</span>
                                                </div>

                                                {/* Satisfa√ß√£o */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Taxa de Satisfa√ß√£o</span>
                                                    <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVerde}`}>{dadosPesquisas.taxaSatisfacao}%</span>
                                                </div>

                                                {/* Detratores */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Detratores</span>
                                                    <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorVermelho}`}>{dadosPesquisas.totalDetratores}</span>
                                                </div>

                                                {/* Neutros */}
                                                <div className={styles.cardGestaoDocResumoLinha}>
                                                    <span className={styles.cardGestaoDocResumoLabel}>Neutros</span>
                                                    <span className={`${styles.cardGestaoDocResumoValor} ${styles.cardGestaoDocResumoValorAmarelo}`}>{dadosPesquisas.totalNeutros}</span>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                ) : (
                                    <div className={styles.cardGestaoDocSemDados}>
                                        <div className={styles.cardGestaoDocSemDadosTexto}>
                                            Nenhum dado de pesquisa dispon√≠vel
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>



                        {/* === PERFORMANCE DO M√äS === */}
                        <div className={styles.performanceMesWrapper}>
                            <div className={styles.performanceMesCard}>
                                {(loadingTarefasAbertas || loadingObrigacoes) ? (
                                    <div className={styles.performanceMesLoading}>
                                        <div className={styles.performanceMesLoadingIcon}>
                                            <SpinnerGlobal size={32} variant="gradient" />
                                        </div>
                                        <div className={styles.performanceMesLoadingText}>
                                            Carregando performance do m√™s...
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        {/* Topo: T√≠tulo e Navega√ß√£o */}
                                        <div className={styles.performanceMesTopo}>
                                            <div className={styles.performanceMesTitulo}>
                                                Performance do M√™s: {new Date(anoSelecionado, mesSelecionado).toLocaleDateString("pt-BR", { month: "short", year: "numeric" }).toUpperCase()}
                                            </div>
                                            <div className={styles.performanceMesNavegacao}>
                                                <FiArrowLeft onClick={voltarMes} />
                                                <FiArrowRight onClick={avancarMes} />
                                            </div>
                                        </div>

                                        {/* Gr√°fico + Infos laterais */}
                                        <div className={styles.performanceMesGraficoLinha}>
                                            {/* Tarefas Realizadas */}
                                            <div
                                                onClick={() => {
                                                    if (tarefasRealizadas.length === 0) return;
                                                    const tarefasRealizadasArray = tarefasRealizadas
                                                        .filter(t => !t.obrigacaoId)
                                                        .map(t => ({ ...t, tipo: "tarefa" }));
                                                    const obrigacoesRealizadasArray = tarefasRealizadas
                                                        .filter(t => t.obrigacaoId)
                                                        .map(t => ({ ...t, tipo: "obrigacao" }));
                                                    abrirModal(
                                                        "Tarefas Realizadas",
                                                        tarefasRealizadasArray,
                                                        obrigacoesRealizadasArray,
                                                        undefined,
                                                        tarefasRealizadasArray.length > 0 ? "solicitacoes" : "obrigacoes"
                                                    );
                                                }}
                                                className={styles.performanceMesRealizadas}
                                            >
                                                <div className={styles.performanceMesRealizadasValor}>{tarefasRealizadas.length}</div>
                                                <div className={styles.performanceMesRealizadasLabel}>Tarefas Realizadas</div>
                                            </div>

                                            {/* Gr√°fico semicircular SEM anima√ß√£o */}
                                            <div className={styles.performanceMesGrafico}>
                                                <CircularProgressbarWithChildren
                                                    value={percentualConcluido}
                                                    maxValue={100}
                                                    strokeWidth={10}
                                                    styles={buildStyles({
                                                        pathColor: "#22c55e",
                                                        trailColor: "#1e1e2e",
                                                        strokeLinecap: "butt",
                                                        rotation: 0.75,
                                                    })}
                                                    circleRatio={0.5}
                                                >
                                                    <div className={styles.performanceMesGraficoValor}>
                                                        {percentualConcluido}%
                                                    </div>
                                                    <div className={styles.performanceMesGraficoLabel}>
                                                        Tarefas Conclu√≠das
                                                    </div>
                                                </CircularProgressbarWithChildren>
                                            </div>

                                            {/* Tarefas Restantes */}
                                            <div
                                                onClick={() =>
                                                    tarefasPendentes.length + obrigacoesPendentes.length > 0 &&
                                                    abrirModal("Tarefas Restantes", tarefasPendentes, obrigacoesPendentes, undefined, "obrigacoes")
                                                }
                                                className={styles.performanceMesRestantes}
                                                style={{
                                                    cursor: tarefasPendentes.length + obrigacoesPendentes.length > 0 ? "pointer" : "default"
                                                }}
                                            >
                                                <div className={styles.performanceMesRestantesValor + " tarefas-tooltip-container"}>
                                                    {tarefasPendentes.length + obrigacoesPendentes.length}
                                                    {/* Tooltip */}
                                                    <div className={styles.tooltipDetalhe}>
                                                        {tarefasPendentes.length} solicita√ß√µes<br />
                                                        {obrigacoesPendentes.length} obriga√ß√µes
                                                    </div>
                                                </div>
                                                <div className={styles.performanceMesRestantesLabel}>Tarefas Restantes</div>
                                            </div>
                                        </div>

                                        {/* Rodap√©: observa√ß√£o + link */}
                                        <div className={styles.performanceMesRodape}>
                                            <div className={styles.performanceMesRodapeObs}>* Por vencimento/prazo</div>
                                            <button
                                                onClick={() => {
                                                    const query = departamentosSelecionados.length > 0
                                                        ? `?departamentos=${encodeURIComponent(departamentosSelecionados.join(','))}`
                                                        : "";
                                                    router.push(`/dashboard/performance-mensal${query}`);
                                                }}
                                                className={styles.performanceMesRodapeBtn}
                                            >
                                                Ver Performance Mensal ‚Üí
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>

                        {/* Painel de Controle */}
                        <div className={styles.controlPanel}>
                            {/* Cabe√ßalho do painel com bot√µes de integra√ß√£o */}
                            <div className={styles.painelControleHeader}>
                                <h3 className={styles.painelControleTitulo}>Painel de Controle</h3>
                                <div className={styles.painelControleIntegracoes}>
                                    <button
                                        title="Iniciar baixa autom√°tica das atividades de integra√ß√£o eContador"
                                        className={styles.cardIntegracaoBtnEcontador}
                                        onClick={() => setModalEcontador(true)}
                                    >
                                        <SVGComponent width={15} height={15} />
                                        eContador
                                    </button>
                                    {/* <button
                    title="Iniciar baixa autom√°tica das atividades de integra√ß√£o Onvio"
                    className={styles.cardIntegracaoBtnOnvio}
                    onClick={() => setModalOnvio(true)}
                  >
                    <OnvioSVG width={15} height={15} />
                    Onvio
                  </button> */}
                                    <button
                                        title="Processar PDFs em lote para extra√ß√£o de dados"
                                        className={styles.cardIntegracaoBtnPdfLayout}
                                        onClick={() => setModalPdfLayoutAberto(true)}
                                    >
                                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                            <polyline points="14,2 14,8 20,8" />
                                            <line x1="16" y1="13" x2="8" y2="13" />
                                            <line x1="16" y1="17" x2="8" y2="17" />
                                            <polyline points="10,9 9,9 8,9" />
                                        </svg>
                                        PDF Layout
                                    </button>
                                </div>
                            </div>

                            {/* Conte√∫do do painel ou estado de carregamento */}
                            {loadingPainelTarefas || loadingPainelObrigacoes ? (
                                <div className={styles.painelControleLoading}>
                                    <div className={styles.painelControleLoadingIcon}>
                                        <SpinnerGlobal size={32} variant="gradient" />
                                    </div>
                                    <div className={styles.painelControleLoadingText}>
                                        Carregando dados do painel...
                                    </div>
                                </div>
                            ) : (
                                <div className={styles.painelControleTabelaWrapper}>
                                    <table className={styles.controlPanelTable}>
                                        <thead className={styles.controlPanelHeader}>
                                            <tr>
                                                <th>Processos e Obriga√ß√µes</th>
                                                <th>
                                                    <span title="A√ß√£o: Pr√≥ximos 15 dias, Programado Hoje, Fora do Programado">
                                                        A√ß√£o
                                                    </span>
                                                </th>
                                                <th>
                                                    <span title="Aten√ß√£o: Ap√≥s Meta, Vence Hoje, Ap√≥s Prazo">
                                                        Aten√ß√£o
                                                    </span>
                                                </th>
                                                <th>
                                                    <span title="Conclu√≠das: Na Programa√ß√£o, Conclu√≠da Ap√≥s Meta, Conclu√≠da Ap√≥s Prazo">
                                                        Conclu√≠das
                                                    </span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {painel
                                                .filter(dep =>
                                                    (departamentosSelecionados.length === 0 || departamentosSelecionados.includes(dep.departamento)) &&
                                                    (
                                                        // Se n√£o filtrou cliente nem grupo, mostra todos os deps normalmente
                                                        (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                        ||
                                                        // Sen√£o, mostra S√ì os deps que tenham ao menos uma tarefa/obriga√ß√£o do cliente OU do grupo selecionado
                                                        dep.acao.tarefas.concat(dep.atencao.tarefas, dep.concluidas.tarefas)
                                                            .some(t =>
                                                            (
                                                                // Cliente filtrado
                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-"))
                                                                ||
                                                                // OU Grupo filtrado (pelo id de cliente)
                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id))
                                                            )
                                                            )
                                                    )
                                                )

                                                .map((dep, i) => (
                                                    <tr
                                                        key={i}
                                                        className={styles.controlPanelRow}
                                                    >
                                                        <td>
                                                            <div
                                                                className={
                                                                    usuarioDepartamento === dep.departamento
                                                                        ? `${styles.painelControleDepartamentoCell} ${styles.painelControleDepartamentoCellAtivo}`
                                                                        : `${styles.painelControleDepartamentoCell} ${styles.painelControleDepartamentoCellInativo}`
                                                                }
                                                            >
                                                                <span>{dep.departamento}</span>
                                                                <div className={styles.relative}>
                                                                    <button
                                                                        onClick={() => toggleDropdown(i)}
                                                                        className={`${styles.painelControleDepartamentoDropdownBtn} painelControleDepartamentoDropdownBtn`}
                                                                    >
                                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 512 512">
                                                                            <path fill="none" stroke="#676A6C" strokeLinecap="round" strokeLinejoin="round" strokeWidth="44" d="M102 256h308m-308-80h308M102 336h308" />
                                                                        </svg>
                                                                    </button>
                                                                    {dropdownAtivo === i && (
                                                                        <div
                                                                            ref={dropdownPainelRef}
                                                                            className={styles.painelControleDepartamentoDropdown}
                                                                        >
                                                                            <button
                                                                                onClick={() => window.open(`/dashboard/agenda?departamento=${encodeURIComponent(dep.departamento)}`, "_blank")}
                                                                                className={styles.painelControleDepartamentoDropdownItem}
                                                                            >
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                                                                                    <g fill="none">
                                                                                        <path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z" />
                                                                                        <path fill="#676A6C" d="M10.89 2.538a2 2 0 0 1 2.072-.09l.147.09l8 5.333a2 2 0 0 1 .884 1.498l.007.166V19a2 2 0 0 1-1.85 1.995L20 21H4a2 2 0 0 1-1.995-1.85L2 19V9.535a2 2 0 0 1 .756-1.566l.135-.098zM12 4.202L4.803 9L12 13.798L19.197 9z" />
                                                                                    </g>
                                                                                </svg>
                                                                                Agenda
                                                                            </button>
                                                                            <button
                                                                                onClick={() => alert("Abrir tarefas")}
                                                                                className={styles.painelControleDepartamentoDropdownItem}
                                                                            >
                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                                                                                    <path fill="#676A6C" fillRule="evenodd" d="M14.25 2.5a.25.25 0 0 0-.25-.25H7A2.75 2.75 0 0 0 4.25 5v14A2.75 2.75 0 0 0 7 21.75h10A2.75 2.75 0 0 0 19.75 19V9.147a.25.25 0 0 0-.25-.25H15a.75.75 0 0 1-.75-.75zm.75 9.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1 0-1.5zm0 4a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1 0-1.5z" clipRule="evenodd" />
                                                                                    <path fill="#676A6C" d="M15.75 2.824c0-.184.193-.301.336-.186q.182.147.323.342l3.013 4.197c.068.096-.006.22-.124.22H16a.25.25 0 0 1-.25-.25z" />
                                                                                </svg>
                                                                                Tarefas
                                                                            </button>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </td>

                                                        {/* A√ß√£o */}
                                                        <td>
                                                            {(() => {
                                                                const valores = [
                                                                    dep.acao.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Pr√≥ximos 15 dias" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ).length,
                                                                    dep.acao.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Programado Hoje" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ).length,
                                                                    dep.acao.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Fora do Programado" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ).length,
                                                                ];



                                                                return celulaTrio(
                                                                    valores,
                                                                    [legendaCores.proximos15dias, legendaCores.programadoHoje, legendaCores.foraProgramado],
                                                                    ["Pr√≥ximos 15 dias", "Programado Hoje", "Fora Programado"],
                                                                    [
                                                                        dep.acao.tarefas.filter(
                                                                            (t) =>
                                                                                t.categoria === "Pr√≥ximos 15 dias" &&
                                                                                (
                                                                                    (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                    (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                    (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                                )
                                                                        ),
                                                                        dep.acao.tarefas.filter(
                                                                            (t) =>
                                                                                t.categoria === "Programado Hoje" &&
                                                                                (
                                                                                    (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                    (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                    (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                                )
                                                                        ),
                                                                        dep.acao.tarefas.filter(
                                                                            (t) =>
                                                                                t.categoria === "Fora do Programado" &&
                                                                                (
                                                                                    (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                    (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                    (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                                )
                                                                        ),
                                                                    ],
                                                                    abrirModal,
                                                                    "action"
                                                                );
                                                            })()}
                                                        </td>

                                                        {/* Aten√ß√£o */}
                                                        <td>
                                                            {celulaTrio(
                                                                [
                                                                    dep.atencao.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Ap√≥s Meta" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ).length,
                                                                    dep.atencao.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Vence Hoje" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ).length,
                                                                    dep.atencao.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Ap√≥s Prazo" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ).length,
                                                                ],
                                                                [legendaCores.aposMeta, legendaCores.venceHoje, legendaCores.aposPrazo],
                                                                ["Ap√≥s Meta", "Vence Hoje", "Ap√≥s Prazo"],
                                                                [
                                                                    dep.atencao.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Ap√≥s Meta" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ),
                                                                    dep.atencao.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Vence Hoje" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ),
                                                                    dep.atencao.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Ap√≥s Prazo" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ),
                                                                ],
                                                                abrirModal,
                                                                "attention"
                                                            )}
                                                        </td>

                                                        {/* Conclu√≠das */}
                                                        <td>
                                                            {celulaTrio(
                                                                [
                                                                    dep.concluidas.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Na Programa√ß√£o" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ).length,
                                                                    dep.concluidas.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Conclu√≠da Ap√≥s Meta" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ).length,
                                                                    dep.concluidas.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Conclu√≠da Ap√≥s Prazo" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ).length,
                                                                ],
                                                                [legendaCores.naProgramacao, legendaCores.conclAposMeta, legendaCores.conclAposPrazo],
                                                                ["Na Programa√ß√£o", "Conclu√≠da Ap√≥s Meta", "Conclu√≠da Ap√≥s Prazo"],
                                                                [
                                                                    dep.concluidas.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Na Programa√ß√£o" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ),
                                                                    dep.concluidas.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Conclu√≠da Ap√≥s Meta" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ),
                                                                    dep.concluidas.tarefas.filter(
                                                                        (t) =>
                                                                            t.categoria === "Conclu√≠da Ap√≥s Prazo" &&
                                                                            (
                                                                                (clientesSelecionados.length > 0 && clientesSelecionados.includes(t.cliente_nome || t.cliente || "-")) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length > 0 && clientesPorGrupo.length > 0 && clientesPorGrupo.includes(t.clienteId || t.idCliente || t.cliente_id || t.id)) ||
                                                                                (clientesSelecionados.length === 0 && gruposSelecionados.length === 0)
                                                                            )
                                                                    ),
                                                                ],
                                                                abrirModal,
                                                                "completed"
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>

                        {/* Legenda de Cores */}
                        <LegendaCores />

                        {modalAberto && (
                            <VisaoGeralModal
                                titulo={tituloModal}
                                tarefas={tarefasModal}
                                onClose={() => setModalAberto(false)}
                                abaAtiva={abaAtiva}
                            />
                        )}



                        {/* Modal de Confirma√ß√£o Onvio */}
                        {modalOnvio && (
                            <div className={styles.modalOverlay}>
                                <div className={styles.modalContent}>
                                    {/* Header */}
                                    <div className={styles.modalHeader}>
                                        <h2 className={styles.modalTitle}>
                                            Integra√ß√£o Onvio - Baixa Autom√°tica
                                        </h2>
                                        <button
                                            onClick={() => setModalOnvio(false)}
                                            className={styles.modalCloseBtn}
                                        >
                                            √ó
                                        </button>
                                    </div>

                                    {/* Content */}
                                    <div className={styles.modalSection}>
                                        <p>
                                            Tem certeza que deseja iniciar a <strong>baixa autom√°tica</strong> das atividades de integra√ß√£o Onvio?
                                        </p>

                                        <div className={styles.onvioInfoBox}>
                                            <h3 className={styles.onvioInfoTitle}>
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                                    <polyline points="14,2 14,8 20,8" />
                                                    <line x1="16" y1="13" x2="8" y2="13" />
                                                    <line x1="16" y1="17" x2="8" y2="17" />
                                                    <polyline points="10,9 9,9 8,9" />
                                                </svg>
                                                O que ser√° processado:
                                            </h3>
                                            <ul className={styles.onvioInfoList}>
                                                <li>Atividades do tipo "Integra√ß√£o: Onvio" pendentes</li>
                                                <li>Login autom√°tico na plataforma Onvio</li>
                                                <li>Busca por documentos com compet√™ncia espec√≠fica</li>
                                                <li>Detec√ß√£o autom√°tica de formatos de compet√™ncia</li>
                                                <li>Baixa autom√°tica das obriga√ß√µes correspondentes</li>
                                            </ul>
                                        </div>

                                        <div className={styles.onvioWarningBox}>
                                            <p className={styles.onvioWarningText}>
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginTop: "1px", flexShrink: 0 }}>
                                                    <circle cx="12" cy="12" r="10" />
                                                    <line x1="12" y1="8" x2="12" y2="12" />
                                                    <line x1="12" y1="16" x2="12.01" y2="16" />
                                                </svg>
                                                <span><strong>Aten√ß√£o:</strong> Este processo pode levar alguns minutos dependendo da quantidade de atividades encontradas.</span>
                                            </p>
                                        </div>
                                    </div>

                                    {/* Action Buttons */}
                                    <div className={styles.onvioActionsRow}>
                                        <button
                                            onClick={() => setModalOnvio(false)}
                                            className={styles.onvioBtnCancel}
                                            disabled={loadingOnvio}
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            onClick={iniciarBaixaOnvio}
                                            className={styles.onvioBtnPrimary}
                                            disabled={loadingOnvio}
                                        >
                                            {loadingOnvio ? (
                                                <div className={styles.onvioBtnPrimaryContent}>
                                                    <SpinnerGlobal size={16} variant="gradient" />
                                                    Processando...
                                                </div>
                                            ) : (
                                                "Iniciar Baixa Autom√°tica"
                                            )}
                                        </button>
                                    </div>

                                    {/* Resultado/Logs */}
                                    {resultadoOnvio && (
                                        <div style={{
                                            marginTop: "var(--titan-spacing-lg)",
                                            maxHeight: "400px",
                                            overflowY: "auto",
                                            background: "var(--titan-base-00)",
                                            padding: "var(--titan-spacing-lg)",
                                            borderRadius: "var(--titan-radius-md)",
                                            border: "1px solid var(--titan-stroke)"
                                        }}>
                                            <h4 style={{
                                                margin: "0 0 var(--titan-spacing-md) 0",
                                                fontSize: "var(--titan-font-size-base)",
                                                fontWeight: "var(--titan-font-weight-semibold)",
                                                color: "var(--titan-text-high)",
                                                display: "flex",
                                                alignItems: "center",
                                                gap: "var(--titan-spacing-sm)"
                                            }}>
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                    <path d="M3 3v18h18" />
                                                    <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" />
                                                </svg>
                                                Resultado do Processamento
                                            </h4>

                                            {resultadoOnvio.error ? (
                                                <div style={{
                                                    background: resultadoOnvio.codigo === 400 ? "var(--titan-warning-bg)" : "var(--titan-error-bg)",
                                                    border: resultadoOnvio.codigo === 400 ? "1px solid var(--titan-warning-border)" : "1px solid var(--titan-error-border)",
                                                    borderRadius: "var(--titan-radius-sm)",
                                                    padding: "var(--titan-spacing-md)",
                                                    color: resultadoOnvio.codigo === 400 ? "var(--titan-warning-text)" : "var(--titan-error-text)"
                                                }}>
                                                    <div style={{ display: "flex", alignItems: "center", gap: "var(--titan-spacing-sm)", marginBottom: "var(--titan-spacing-sm)" }}>
                                                        {resultadoOnvio.codigo === 400 ? (
                                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                <circle cx="12" cy="12" r="10" />
                                                                <line x1="12" y1="8" x2="12" y2="12" />
                                                                <line x1="12" y1="16" x2="12.01" y2="16" />
                                                            </svg>
                                                        ) : (
                                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                <circle cx="12" cy="12" r="10" />
                                                                <line x1="15" y1="9" x2="9" y2="15" />
                                                                <line x1="9" y1="9" x2="15" y2="15" />
                                                            </svg>
                                                        )}
                                                        <strong>
                                                            {resultadoOnvio.codigo === 400 ? "Configura√ß√£o Necess√°ria" : "Erro no Processamento"}
                                                        </strong>
                                                    </div>
                                                    <p style={{ margin: 0, fontSize: "var(--titan-font-size-sm)", lineHeight: "1.5" }}>{resultadoOnvio.error}</p>

                                                    {/* üî• NOVO: A√ß√µes espec√≠ficas para credenciais n√£o configuradas */}
                                                    {resultadoOnvio.codigo === 400 && resultadoOnvio.error.includes('Credenciais Onvio n√£o configuradas') && (
                                                        <div style={{
                                                            marginTop: "var(--titan-spacing-md)",
                                                            padding: "var(--titan-spacing-sm)",
                                                            background: "rgba(255, 255, 255, 0.5)",
                                                            borderRadius: "var(--titan-radius-sm)",
                                                            border: "1px solid rgba(245, 158, 11, 0.3)"
                                                        }}>
                                                            <p style={{ margin: "0 0 var(--titan-spacing-sm) 0", fontSize: "13px", fontWeight: "var(--titan-font-weight-medium)" }}>
                                                                <strong>Para resolver:</strong>
                                                            </p>
                                                            <ul style={{ margin: 0, paddingLeft: "20px", fontSize: "13px" }}>
                                                                <li>Clique na sua foto</li>
                                                                <li>Acesse "Minha Empresa"</li>
                                                                <li>Clique em "Integra√ß√µes" e adicione seu e-mail e senha</li>
                                                            </ul>
                                                        </div>
                                                    )}
                                                </div>
                                            ) : (
                                                <div>
                                                    {/* Resumo Geral */}
                                                    <div style={{
                                                        background: "var(--titan-success-bg)",
                                                        border: "1px solid var(--titan-success-border)",
                                                        borderRadius: "var(--titan-radius-sm)",
                                                        padding: "var(--titan-spacing-sm)",
                                                        marginBottom: "var(--titan-spacing-md)"
                                                    }}>
                                                        <div style={{ display: "flex", alignItems: "center", gap: "var(--titan-spacing-sm)", marginBottom: "var(--titan-spacing-sm)" }}>
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                <path d="M9 12l2 2 4-4" />
                                                                <circle cx="12" cy="12" r="10" />
                                                            </svg>
                                                            <strong style={{ color: "var(--titan-success-text)" }}>Processamento Conclu√≠do</strong>
                                                        </div>
                                                        <p style={{ margin: 0, fontSize: "var(--titan-font-size-sm)", color: "var(--titan-success-text)" }}>
                                                            {resultadoOnvio.message || "Baixa autom√°tica realizada com sucesso"}
                                                        </p>
                                                    </div>

                                                    {/* Detalhes do Processamento */}
                                                    {resultadoOnvio.detalhes && Array.isArray(resultadoOnvio.detalhes) && (
                                                        <div>
                                                            <h5 style={{
                                                                margin: "0 0 var(--titan-spacing-sm) 0",
                                                                fontSize: "var(--titan-font-size-sm)",
                                                                fontWeight: "var(--titan-font-weight-semibold)",
                                                                color: "var(--titan-text-high)"
                                                            }}>
                                                                Detalhes por Atividade:
                                                            </h5>

                                                            {resultadoOnvio.detalhes.map((detalhe, index) => (
                                                                <div key={index} style={{
                                                                    background: "var(--titan-base-00)",
                                                                    border: "1px solid var(--titan-stroke)",
                                                                    borderRadius: "var(--titan-radius-sm)",
                                                                    padding: "var(--titan-spacing-sm)",
                                                                    marginBottom: "var(--titan-spacing-sm)"
                                                                }}>
                                                                    <div style={{ display: "flex", alignItems: "center", gap: "var(--titan-spacing-sm)", marginBottom: "6px" }}>
                                                                        {detalhe.status === 'SUCESSO' ? (
                                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--titan-success)" strokeWidth="2">
                                                                                <path d="M9 12l2 2 4-4" />
                                                                                <circle cx="12" cy="12" r="10" />
                                                                            </svg>
                                                                        ) : (
                                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--titan-error)" strokeWidth="2">
                                                                                <circle cx="12" cy="12" r="10" />
                                                                                <line x1="15" y1="9" x2="9" y2="15" />
                                                                                <line x1="9" y1="9" x2="15" y2="15" />
                                                                            </svg>
                                                                        )}
                                                                        <span style={{
                                                                            fontWeight: "var(--titan-font-weight-semibold)",
                                                                            color: detalhe.status === 'SUCESSO' ? "var(--titan-success)" : "var(--titan-error)"
                                                                        }}>
                                                                            {detalhe.clienteNome}
                                                                        </span>
                                                                        <span style={{
                                                                            fontSize: "12px",
                                                                            color: "var(--titan-text-med)",
                                                                            background: "var(--titan-input-bg)",
                                                                            padding: "2px 6px",
                                                                            borderRadius: "var(--titan-radius-xs)"
                                                                        }}>
                                                                            {detalhe.status}
                                                                        </span>
                                                                    </div>

                                                                    <div style={{ fontSize: "13px", color: "var(--titan-text-high)", marginBottom: "4px" }}>
                                                                        <strong>Atividade:</strong> {detalhe.tituloDocumentoEsperado}
                                                                    </div>

                                                                    <div style={{ fontSize: "12px", color: "var(--titan-text-med)", marginBottom: "4px" }}>
                                                                        <strong>ID:</strong> {detalhe.atividadeId}
                                                                    </div>

                                                                    <div style={{ fontSize: "12px", color: "var(--titan-text-med)" }}>
                                                                        {detalhe.mensagem}
                                                                    </div>

                                                                    {detalhe.documentosEncontrados && detalhe.documentosEncontrados.length > 0 && (
                                                                        <div style={{ marginTop: "var(--titan-spacing-sm)", fontSize: "12px", color: "var(--titan-text-med)" }}>
                                                                            <strong>Documentos:</strong> {detalhe.documentosEncontrados.length} encontrado(s)
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}

                                                    {/* Estat√≠sticas */}
                                                    {resultadoOnvio.detalhes && Array.isArray(resultadoOnvio.detalhes) && (
                                                        <div style={{
                                                            background: "var(--titan-base-00)",
                                                            border: "1px solid var(--titan-stroke)",
                                                            borderRadius: "var(--titan-radius-sm)",
                                                            padding: "var(--titan-spacing-sm)",
                                                            marginTop: "var(--titan-spacing-md)"
                                                        }}>
                                                            <h6 style={{
                                                                margin: "0 0 var(--titan-spacing-sm) 0",
                                                                fontSize: "13px",
                                                                fontWeight: "var(--titan-font-weight-semibold)",
                                                                color: "var(--titan-text-high)"
                                                            }}>
                                                                Estat√≠sticas:
                                                            </h6>
                                                            <div style={{ display: "flex", gap: "var(--titan-spacing-md)", fontSize: "12px", color: "var(--titan-text-med)" }}>
                                                                <div>
                                                                    <strong>Total processado:</strong> {resultadoOnvio.detalhes.length}
                                                                </div>
                                                                <div>
                                                                    <strong>Sucessos:</strong> {resultadoOnvio.detalhes.filter((d) => d.status === 'SUCESSO').length}
                                                                </div>
                                                                <div>
                                                                    <strong>Falhas:</strong> {resultadoOnvio.detalhes.filter((d) => d.status === 'FALHA').length}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>

                                    )}
                                </div>
                            </div>
                        )}

                        {/* Modal eContador */}
                        <ModalEcontador
                            open={modalEcontador}
                            onClose={() => setModalEcontador(false)}
                            loading={loadingEcontador}
                            onConfirm={iniciarBaixaEcontador}
                            resultado={resultadoEcontador}
                        />
                        {/* Modal PDF Layout */}
                        <ModalPdfLayout
                            open={modalPdfLayoutAberto}
                            onClose={fecharModalPdfLayout}
                            arquivosSelecionados={arquivosSelecionados}
                            setArquivosSelecionados={setArquivosSelecionados}
                            processandoArquivo={processandoArquivo}
                            resultadoProcessamento={resultadoProcessamento}
                            onProcessar={processarArquivos}
                            onDrag={handleDrag}
                            onDrop={handleDrop}
                            onFileSelect={handleFileSelect}
                            dragActive={dragActive}
                        />
                    </main>
                </div>
            </div>
        </>
    );
};